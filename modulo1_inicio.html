<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeoStudy - Crear Cuenta / Iniciar Sesi√≥n</title>
<!-- Incluir Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* Tus estilos CSS existentes se mantienen igual */
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    overflow-x: hidden;
    background: linear-gradient(120deg, #001F3F, #003366, #00C4FF);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    padding: 20px;
  }

  /* ... (todo tu CSS existente se mantiene igual) ... */

</style>
</head>
<body>

<div class="container">
  <h1>NeoStudy üöÄ</h1>
  <p>Tu educaci√≥n digital comienza aqu√≠</p>

  <!-- Selecci√≥n de categor√≠a -->
  <select id="categoria">
    <option value="">Selecciona tu categor√≠a</option>
    <option value="profesional">Profesional</option>
    <option value="universitario">Estudiante Universitario</option>
    <option value="secundaria">Alumno de Secundaria</option>
    <option value="general">P√∫blico en general</option>
  </select>

  <!-- Formularios din√°micos (se mantienen igual) -->
  <form id="formProfesional" class="hidden">
    <input type="text" id="prof_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="prof_profesion" placeholder="Profesi√≥n" required>
    <input type="text" id="prof_carrera" placeholder="Carrera" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="prof_nacimiento" required>
    <input type="email" id="prof_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="prof_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formUniversitario" class="hidden">
    <input type="text" id="uni_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="uni_universidad" placeholder="Universidad" required>
    <input type="text" id="uni_carrera" placeholder="Carrera" required>
    <input type="text" id="uni_ciclo" placeholder="Ciclo/A√±o" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="uni_nacimiento" required>
    <input type="email" id="uni_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="uni_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formSecundaria" class="hidden">
    <input type="text" id="sec_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="sec_colegio" placeholder="Colegio" required>
    <input type="text" id="sec_grado" placeholder="Grado/Secci√≥n" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="sec_nacimiento" required>
    <input type="email" id="sec_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="sec_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formGeneral" class="hidden">
    <input type="text" id="gen_nombre" placeholder="Nombre y Apellido" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="gen_nacimiento" required>
    <input type="email" id="gen_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="gen_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <h3>O Inicia Sesi√≥n</h3>
  <input type="email" id="login_contacto" placeholder="Correo Electr√≥nico">
  <input type="password" id="login_password" placeholder="Contrase√±a">
  <button id="btnLogin">Iniciar Sesi√≥n</button>

  <div class="footer">
    ¬øNo tienes cuenta? <a id="btnCrearCuenta">Crea tu cuenta</a>
  </div>
</div>

<script>
// Configuraci√≥n de Supabase
const supabaseUrl = 'https://qmzoblunltlathycycaw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtem9ibHVubHRsYXRoeWN5Y2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzM4MDcsImV4cCI6MjA3OTkwOTgwN30.1n3A41f5HPg2QfNBOESH1xLgAl-MNX7-_R97M8NsRnA';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const categoriaSelect = document.getElementById("categoria");
const forms = {
  profesional: document.getElementById("formProfesional"),
  universitario: document.getElementById("formUniversitario"),
  secundaria: document.getElementById("formSecundaria"),
  general: document.getElementById("formGeneral")
};

// SOLUCI√ìN PROBLEMA 1: Bot√≥n "Crear cuenta" funcional
document.getElementById("btnCrearCuenta").addEventListener("click", function() {
  categoriaSelect.scrollIntoView({ behavior: 'smooth' });
  categoriaSelect.focus();
  alert("Por favor selecciona tu categor√≠a para crear tu cuenta");
});

// Mostrar formulario seg√∫n categor√≠a
categoriaSelect.addEventListener("change", () => {
  const value = categoriaSelect.value;
  Object.values(forms).forEach(f => f.classList.add("hidden"));
  if(value && forms[value]) forms[value].classList.remove("hidden");
});

// Funci√≥n para guardar usuario en Supabase
async function saveUser(form, category) {
  try {
    const data = { 
      categoria: category,
      fecha_creacion: new Date().toISOString()
    };
    
    // Recopilar datos del formulario
    Array.from(form.elements).forEach(input => {
      if(input.type !== "submit" && input.value) {
        // Limpiar el ID del campo para guardar en la base de datos
        const fieldName = input.id.replace(`${category}_`, '');
        data[fieldName] = input.value;
      }
    });
    
    // Extraer datos espec√≠ficos para el perfil
    const email = data.contacto;
    const password = data.password;
    const nombre = data.nombre;
    const fechaNacimiento = data.nacimiento;

    if (!email || !password || !nombre) {
      alert("Por favor completa todos los campos requeridos");
      return;
    }

    // 1. Registrar el usuario en Auth de Supabase
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          nombre: nombre,
          categoria: category,
          fecha_nacimiento: fechaNacimiento
        }
      }
    });

    if (authError) {
      throw new Error(authError.message);
    }

    // 2. Guardar datos adicionales en la tabla 'usuarios'
    const { error: dbError } = await supabase
      .from('usuarios')
      .insert([
        {
          id: authData.user.id,
          email: email,
          nombre: nombre,
          categoria: category,
          fecha_nacimiento: fechaNacimiento,
          profesion: data.profesion || null,
          carrera: data.carrera || null,
          universidad: data.universidad || null,
          ciclo: data.ciclo || null,
          colegio: data.colegio || null,
          grado: data.grado || null,
          telefono: data.telefono || null
        }
      ]);

    if (dbError) {
      throw new Error(dbError.message);
    }

    alert("Cuenta creada con √©xito ‚úÖ\nRevisa tu email para verificar tu cuenta.");
    
    // Guardar tambi√©n en localStorage para uso inmediato
    localStorage.setItem("usuarioNeoStudy", JSON.stringify({
      id: authData.user.id,
      email: email,
      nombre: nombre,
      categoria: category,
      fechaNacimiento: fechaNacimiento
    }));
    
    window.location.href = "modulo2_iniciodecesi√≥n.html";

  } catch (error) {
    console.error('Error al crear cuenta:', error);
    alert(`Error al crear cuenta: ${error.message}`);
  }
}

// Funci√≥n para iniciar sesi√≥n
async function loginUser(email, password) {
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      throw new Error(error.message);
    }

    // Obtener datos adicionales del usuario
    const { data: userData, error: userError } = await supabase
      .from('usuarios')
      .select('*')
      .eq('id', data.user.id)
      .single();

    if (userError) {
      console.error('Error al obtener datos del usuario:', userError);
    }

    // Guardar en localStorage
    localStorage.setItem("usuarioNeoStudy", JSON.stringify({
      id: data.user.id,
      email: data.user.email,
      nombre: userData?.nombre || data.user.user_metadata?.nombre,
      categoria: userData?.categoria,
      fechaNacimiento: userData?.fecha_nacimiento
    }));

    alert("Inicio de sesi√≥n exitoso ‚úÖ");
    window.location.href = "modulo2_iniciodecesi√≥n.html";

  } catch (error) {
    console.error('Error al iniciar sesi√≥n:', error);
    alert(`Error al iniciar sesi√≥n: ${error.message}`);
  }
}

// Asignar eventos a los formularios
Object.keys(forms).forEach(cat => {
  forms[cat].addEventListener("submit", async e => {
    e.preventDefault();
    await saveUser(forms[cat], cat);
  });
});

// Evento para login
document.getElementById("btnLogin").addEventListener("click", async () => {
  const email = document.getElementById("login_contacto").value;
  const password = document.getElementById("login_password").value;
  
  if (!email || !password) {
    alert("Por favor completa todos los campos");
    return;
  }

  await loginUser(email, password);
});

// Mejora adicional: Formatear fecha para mostrar en el perfil
function formatearFecha(fechaISO) {
  if (!fechaISO) return "";
  const fecha = new Date(fechaISO);
  const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
  return fecha.toLocaleDateString('es-ES', opciones);
}

// Verificar si el usuario ya est√° autenticado
async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    // Si ya hay sesi√≥n, redirigir al dashboard
    window.location.href = "modulo2_iniciodecesi√≥n.html";
  }
}

// Ejecutar verificaci√≥n al cargar la p√°gina
checkAuth();
</script>
</body>
</html>
