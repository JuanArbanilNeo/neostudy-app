<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoStudy - Crear Cuenta / Iniciar Sesi√≥n</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: "Poppins", sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            overflow-x: hidden;
            background: linear-gradient(120deg, #001F3F, #003366, #00C4FF);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.4);
        }

        h1 { 
            color: #00C4FF; 
            font-size: 2em; 
            margin-bottom: 15px; 
        }
        
        p { 
            font-size: 1em; 
            color: #dfe9ff; 
            margin-bottom: 25px; 
        }

        select, input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            border: none;
            font-size: 1em;
        }

        input { 
            background: rgba(255,255,255,0.9); 
            color: #333; 
        }
        
        input:focus { 
            outline: none; 
            box-shadow: 0 0 12px #00C4FF; 
            transform: scale(1.03); 
        }

        button {
            background: linear-gradient(90deg,#00C4FF,#007bff);
            color: white;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 0 15px #00C4FF;
            transition: 0.3s;
        }

        button:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 25px #00FFFF; 
        }

        .footer { 
            margin-top: 15px; 
            font-size: 0.9em; 
            color: #cbd7ff; 
        }
        
        .footer a { 
            color: #00C4FF; 
            text-decoration: none; 
            cursor: pointer;
            font-weight: bold;
        }
        
        .footer a:hover { 
            text-decoration: underline; 
        }

        .hidden { 
            display: none; 
        }
        
        /* Estilos para etiquetas de fecha */
        .date-label {
            display: block;
            text-align: left;
            margin: 10px 0 5px;
            color: #dfe9ff;
            font-size: 0.9em;
        }
        
        /* Mejoras para dispositivos m√≥viles */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }
            
            .container {
                padding: 20px;
                border-radius: 15px;
                margin-top: 20px;
            }
            
            h1 {
                font-size: 1.7em;
            }
            
            select, input, button {
                padding: 14px;
                font-size: 16px; /* Evita zoom autom√°tico en iOS */
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #00C4FF;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ff6b6b;
        }

        .success-message {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #51cf66;
        }

        .sync-info {
            background: rgba(0, 196, 255, 0.1);
            border: 1px solid #00C4FF;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="loadingText">Procesando...</p>
</div>

<div class="container">
    <h1>NeoStudy üöÄ</h1>
    <p>Tu educaci√≥n digital comienza aqu√≠</p>

    <!-- Informaci√≥n de sincronizaci√≥n -->
    <div class="sync-info">
        üîÑ <strong>Sincronizaci√≥n en la nube activada</strong><br>
        Tus datos estar√°n disponibles en todos tus dispositivos
    </div>

    <!-- Mensajes de estado -->
    <div id="messageContainer"></div>

    <!-- Selecci√≥n de categor√≠a -->
    <select id="categoria">
        <option value="">Selecciona tu categor√≠a</option>
        <option value="profesional">Profesional</option>
        <option value="universitario">Estudiante Universitario</option>
        <option value="secundaria">Alumno de Secundaria</option>
        <option value="general">P√∫blico en general</option>
    </select>

    <!-- Formularios din√°micos -->
    <form id="formProfesional" class="hidden">
        <input type="text" id="prof_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="prof_profesion" placeholder="Profesi√≥n" required>
        <input type="text" id="prof_carrera" placeholder="Carrera" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="prof_nacimiento" required>
        <input type="email" id="prof_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="prof_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formUniversitario" class="hidden">
        <input type="text" id="uni_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="uni_universidad" placeholder="Universidad" required>
        <input type="text" id="uni_carrera" placeholder="Carrera" required>
        <input type="text" id="uni_ciclo" placeholder="Ciclo/A√±o" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="uni_nacimiento" required>
        <input type="email" id="uni_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="uni_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formSecundaria" class="hidden">
        <input type="text" id="sec_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="sec_colegio" placeholder="Colegio" required>
        <input type="text" id="sec_grado" placeholder="Grado/Secci√≥n" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="sec_nacimiento" required>
        <input type="email" id="sec_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="sec_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formGeneral" class="hidden">
        <input type="text" id="gen_nombre" placeholder="Nombre y Apellido" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="gen_nacimiento" required>
        <input type="email" id="gen_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="gen_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <h3>O Inicia Sesi√≥n</h3>
    <input type="email" id="login_email" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="login_password" placeholder="Contrase√±a" required>
    <button id="btnLogin">Iniciar Sesi√≥n</button>

    <div class="footer">
        ¬øNo tienes cuenta? <a id="btnCrearCuenta">Crea tu cuenta</a>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

<script>
// ‚úÖ CONFIGURACI√ìN FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyCHB95PmLOai7HLaNPxVoe0lVwLKIwkgEw",
    authDomain: "neostudy-6c7ad.firebaseapp.com",
    projectId: "neostudy-6c7ad",
    storageBucket: "neostudy-6c7ad.firebasestorage.app",
    messagingSenderId: "764552186350",
    appId: "1:764552186350:web:c744108415108889e826ff",
    measurementId: "G-NB40VTEZB3"
};

// Inicializar Firebase
let auth, db, storage;
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
    console.log("‚úÖ Firebase inicializado correctamente");
} catch (error) {
    console.error("‚ùå Error al inicializar Firebase:", error);
}

// üîπ ELEMENTOS DEL DOM
const categoriaSelect = document.getElementById("categoria");
const messageContainer = document.getElementById("messageContainer");
const loadingElement = document.getElementById("loading");
const loadingText = document.getElementById("loadingText");

const forms = {
    profesional: document.getElementById("formProfesional"),
    universitario: document.getElementById("formUniversitario"),
    secundaria: document.getElementById("formSecundaria"),
    general: document.getElementById("formGeneral")
};

// üîπ FUNCIONES DE UTILIDAD
function showLoading(text = "Procesando...") {
    loadingText.textContent = text;
    loadingElement.style.display = 'flex';
}

function hideLoading() {
    loadingElement.style.display = 'none';
}

function showMessage(message, type = 'error') {
    messageContainer.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
    setTimeout(() => {
        messageContainer.innerHTML = '';
    }, 5000);
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// üîπ INICIALIZAR DATOS DE USUARIO EN FIRESTORE
async function initializeUserData(uid, userData) {
    try {
        console.log("üîÑ Inicializando datos del usuario...");
        
        // Crear estructura inicial de datos del usuario
        const userStructure = {
            // Perfil del usuario
            perfil: {
                nombre: userData.nombre,
                email: userData.email,
                categoria: userData.categoria,
                fechaNacimiento: userData.fechaNacimiento,
                fechaRegistro: new Date().toISOString(),
                fotoPerfil: "", // URL de la foto de perfil
                tema: "claro" // Preferencia de tema
            },
            
            // Libros comprados
            biblioteca: {
                librosComprados: [],
                favoritos: [],
                ultimaLectura: null,
                progresoGlobal: 0
            },
            
            // Configuraciones
            configuraciones: {
                notificaciones: true,
                sincronizacionAuto: true,
                idioma: "es",
                modoOffline: false
            },
            
            // Datos de aprendizaje
            progreso: {
                cursosCompletados: 0,
                horasEstudiadas: 0,
                logros: [],
                puntos: 0
            },
            
            // Dispositivos conectados
            dispositivos: [{
                tipo: navigator.userAgent.includes('Mobile') ? 'movil' : 'escritorio',
                ultimaConexion: new Date().toISOString(),
                id: generateDeviceId()
            }]
        };

        // Agregar campos espec√≠ficos por categor√≠a
        if (userData.categoria === 'profesional') {
            userStructure.perfil.profesion = userData.profesion;
            userStructure.perfil.carrera = userData.carrera;
        } else if (userData.categoria === 'universitario') {
            userStructure.perfil.universidad = userData.universidad;
            userStructure.perfil.carrera = userData.carrera;
            userStructure.perfil.ciclo = userData.ciclo;
        } else if (userData.categoria === 'secundaria') {
            userStructure.perfil.colegio = userData.colegio;
            userStructure.perfil.grado = userData.grado;
        }

        // Guardar estructura en Firestore
        await db.collection('usuarios').doc(uid).set(userStructure, { merge: true });
        
        console.log("‚úÖ Datos de usuario inicializados correctamente");
        return true;
    } catch (error) {
        console.error("‚ùå Error al inicializar datos:", error);
        return false;
    }
}

// Generar ID √∫nico para el dispositivo
function generateDeviceId() {
    return 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// üîπ MOSTRAR FORMULARIOS SEG√öN CATEGOR√çA
document.getElementById("btnCrearCuenta").addEventListener("click", function() {
    categoriaSelect.scrollIntoView({ behavior: 'smooth' });
    categoriaSelect.focus();
    showMessage("Por favor selecciona tu categor√≠a para crear tu cuenta", 'success');
});

categoriaSelect.addEventListener("change", () => {
    const value = categoriaSelect.value;
    Object.values(forms).forEach(f => f.classList.add("hidden"));
    if(value && forms[value]) forms[value].classList.remove("hidden");
});

// üîπ CREAR CUENTA CON FIREBASE
async function saveUser(form, category) {
    try {
        showLoading("Creando tu cuenta...");
        
        const inputs = form.querySelectorAll('input');
        let email = '';
        let password = '';
        let userData = { 
            categoria: category,
            fechaRegistro: new Date().toISOString()
        };

        // Recoger todos los datos del formulario
        inputs.forEach(input => {
            if (input.type !== 'submit') {
                userData[input.id] = input.value;
                
                if (input.type === 'email') {
                    email = input.value.trim().toLowerCase();
                }
                if (input.type === 'password') {
                    password = input.value;
                }
                if (input.type === 'date') {
                    userData.fechaNacimiento = input.value;
                }
            }
        });

        // Validaciones
        if (!email || !password) {
            hideLoading();
            showMessage("Por favor ingresa un correo y contrase√±a v√°lidos");
            return;
        }

        if (!isValidEmail(email)) {
            hideLoading();
            showMessage("Por favor ingresa un correo electr√≥nico v√°lido");
            return;
        }

        if (password.length < 6) {
            hideLoading();
            showMessage("La contrase√±a debe tener al menos 6 caracteres");
            return;
        }

        console.log("üìù Intentando crear usuario:", email);

        // CREAR USUARIO EN FIREBASE AUTH
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        console.log("‚úÖ Usuario creado en Auth:", user.uid);

        // PREPARAR DATOS PARA INICIALIZACI√ìN
        const userProfile = {
            nombre: userData.prof_nombre || userData.uni_nombre || userData.sec_nombre || userData.gen_nombre,
            email: email,
            categoria: category,
            fechaNacimiento: userData.fechaNacimiento
        };

        // Agregar campos espec√≠ficos por categor√≠a
        if (category === 'profesional') {
            userProfile.profesion = userData.prof_profesion;
            userProfile.carrera = userData.prof_carrera;
        } else if (category === 'universitario') {
            userProfile.universidad = userData.uni_universidad;
            userProfile.carrera = userData.uni_carrera;
            userProfile.ciclo = userData.uni_ciclo;
        } else if (category === 'secundaria') {
            userProfile.colegio = userData.sec_colegio;
            userProfile.grado = userData.sec_grado;
        }

        // INICIALIZAR DATOS EN FIRESTORE
        showLoading("Configurando tu perfil...");
        await initializeUserData(user.uid, userProfile);

        hideLoading();
        showMessage("‚úÖ Cuenta creada con √©xito. Tus datos se sincronizar√°n en todos tus dispositivos!", 'success');
        
        // Limpiar formulario
        form.reset();
        
        // Redirigir despu√©s de 2 segundos
        setTimeout(() => {
            window.location.href = "modulo2_iniciodecesi√≥n.html";
        }, 2000);

    } catch (error) {
        hideLoading();
        console.error("‚ùå Error completo:", error);
        
        // Manejo espec√≠fico de errores
        if (error.code === 'auth/email-already-in-use') {
            showMessage("‚ùå Este correo ya est√° registrado. Por favor inicia sesi√≥n.");
        } else if (error.code === 'auth/weak-password') {
            showMessage("‚ùå La contrase√±a debe tener al menos 6 caracteres.");
        } else if (error.code === 'auth/invalid-email') {
            showMessage("‚ùå El formato del correo electr√≥nico no es v√°lido.");
        } else if (error.code === 'auth/operation-not-allowed') {
            showMessage("‚ùå Error del sistema. Contacta al administrador.");
        } else {
            showMessage("‚ùå Error al crear cuenta: " + error.message);
        }
    }
}

// üîπ INICIAR SESI√ìN CON FIREBASE
document.getElementById("btnLogin").addEventListener("click", async () => {
    const email = document.getElementById("login_email").value.trim().toLowerCase();
    const password = document.getElementById("login_password").value;
    
    if (!email || !password) {
        showMessage("Por favor completa todos los campos");
        return;
    }

    if (!isValidEmail(email)) {
        showMessage("Por favor ingresa un correo electr√≥nico v√°lido");
        return;
    }

    try {
        showLoading("Iniciando sesi√≥n...");
        console.log("üîê Intentando iniciar sesi√≥n:", email);
        
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        console.log("‚úÖ Sesi√≥n iniciada para:", user.email);

        // ACTUALIZAR DISPOSITIVO EN FIRESTORE
        showLoading("Sincronizando datos...");
        const deviceInfo = {
            tipo: navigator.userAgent.includes('Mobile') ? 'movil' : 'escritorio',
            ultimaConexion: new Date().toISOString(),
            id: generateDeviceId()
        };

        await db.collection('usuarios').doc(user.uid).update({
            ultimoAcceso: new Date().toISOString(),
            [`dispositivos.${deviceInfo.id}`]: deviceInfo
        });

        // VERIFICAR SI EXISTE ESTRUCTURA DE DATOS
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (!userDoc.exists) {
            console.log("üîÑ Usuario nuevo, inicializando estructura...");
            await initializeUserData(user.uid, {
                nombre: user.email.split('@')[0],
                email: user.email,
                categoria: 'general',
                fechaNacimiento: null
            });
        }

        hideLoading();
        showMessage("‚úÖ Inicio de sesi√≥n exitoso. Sincronizando tus datos...", 'success');
        
        // Limpiar campos de login
        document.getElementById('login_email').value = '';
        document.getElementById('login_password').value = '';
        
        // Redirigir despu√©s de 1 segundo
        setTimeout(() => {
            window.location.href = "modulo2_iniciodecesi√≥n.html";
        }, 1000);

    } catch (error) {
        hideLoading();
        console.error("‚ùå Error de login:", error);
        
        if (error.code === 'auth/user-not-found') {
            showMessage("‚ùå No existe una cuenta con este correo. Por favor crea una cuenta primero.");
        } else if (error.code === 'auth/wrong-password') {
            showMessage("‚ùå Contrase√±a incorrecta. Intenta nuevamente.");
        } else if (error.code === 'auth/invalid-email') {
            showMessage("‚ùå El formato del correo electr√≥nico no es v√°lido.");
        } else if (error.code === 'auth/invalid-login-credentials') {
            showMessage("‚ùå Correo o contrase√±a incorrectos. Verifica tus credenciales.");
        } else if (error.code === 'auth/too-many-requests') {
            showMessage("‚ùå Demasiados intentos fallidos. Intenta m√°s tarde.");
        } else {
            showMessage("‚ùå Error al iniciar sesi√≥n: " + error.message);
        }
    }
});

// üîπ ASIGNAR EVENTOS A LOS FORMULARIOS
Object.keys(forms).forEach(cat => {
    forms[cat].addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveUser(forms[cat], cat);
    });
});

// üîπ VERIFICAR ESTADO DE AUTENTICACI√ìN
auth.onAuthStateChanged((user) => {
    if (user) {
        console.log("üë§ Usuario autenticado:", user.email);
        console.log("üì± Tipo de dispositivo:", navigator.userAgent.includes('Mobile') ? 'M√≥vil' : 'Escritorio');
        
        // Opcional: redirigir autom√°ticamente si ya est√° logueado
        // window.location.href = "modulo2_iniciodecesi√≥n.html";
    } else {
        console.log("üîí No hay usuario autenticado");
    }
});

// üîπ FUNCIONES PARA SINCRONIZACI√ìN (para usar en otros m√≥dulos)
// Estas funciones deben implementarse en tus otros archivos HTML

// Funci√≥n para guardar libros comprados
window.guardarLibroComprado = async function(libroData) {
    try {
        const user = auth.currentUser;
        if (!user) return false;

        await db.collection('usuarios').doc(user.uid).update({
            'biblioteca.librosComprados': firebase.firestore.FieldValue.arrayUnion(libroData),
            'ultimoAcceso': new Date().toISOString()
        });
        
        console.log("‚úÖ Libro guardado en la nube:", libroData.titulo);
        return true;
    } catch (error) {
        console.error("‚ùå Error al guardar libro:", error);
        return false;
    }
};

// Funci√≥n para guardar foto de perfil
window.guardarFotoPerfil = async function(fotoUrl) {
    try {
        const user = auth.currentUser;
        if (!user) return false;

        await db.collection('usuarios').doc(user.uid).update({
            'perfil.fotoPerfil': fotoUrl,
            'ultimoAcceso': new Date().toISOString()
        });
        
        console.log("‚úÖ Foto de perfil guardada en la nube");
        return true;
    } catch (error) {
        console.error("‚ùå Error al guardar foto:", error);
        return false;
    }
};

// Funci√≥n para cargar datos del usuario
window.cargarDatosUsuario = async function() {
    try {
        const user = auth.currentUser;
        if (!user) return null;

        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (userDoc.exists) {
            console.log("‚úÖ Datos cargados desde Firestore");
            return userDoc.data();
        }
        return null;
    } catch (error) {
        console.error("‚ùå Error al cargar datos:", error);
        return null;
    }
};

console.log("üîÑ Sistema de sincronizaci√≥n activado");
console.log("üìö Los libros y fotos se guardar√°n en la nube autom√°ticamente");
</script>
</body>
</html>
