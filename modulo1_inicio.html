<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoStudy - Crear Cuenta / Iniciar Sesi√≥n</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: "Poppins", sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            overflow-x: hidden;
            background: linear-gradient(120deg, #001F3F, #003366, #00C4FF);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.4);
        }

        h1 { 
            color: #00C4FF; 
            font-size: 2em; 
            margin-bottom: 15px; 
        }
        
        p { 
            font-size: 1em; 
            color: #dfe9ff; 
            margin-bottom: 25px; 
        }

        select, input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            border: none;
            font-size: 1em;
        }

        input { 
            background: rgba(255,255,255,0.9); 
            color: #333; 
        }
        
        input:focus { 
            outline: none; 
            box-shadow: 0 0 12px #00C4FF; 
            transform: scale(1.03); 
        }

        button {
            background: linear-gradient(90deg,#00C4FF,#007bff);
            color: white;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 0 15px #00C4FF;
            transition: 0.3s;
        }

        button:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 25px #00FFFF; 
        }

        .footer { 
            margin-top: 15px; 
            font-size: 0.9em; 
            color: #cbd7ff; 
        }
        
        .footer a { 
            color: #00C4FF; 
            text-decoration: none; 
            cursor: pointer;
            font-weight: bold;
        }
        
        .footer a:hover { 
            text-decoration: underline; 
        }

        .hidden { 
            display: none; 
        }
        
        /* Estilos para etiquetas de fecha */
        .date-label {
            display: block;
            text-align: left;
            margin: 10px 0 5px;
            color: #dfe9ff;
            font-size: 0.9em;
        }
        
        /* Mejoras para dispositivos m√≥viles */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }
            
            .container {
                padding: 20px;
                border-radius: 15px;
                margin-top: 20px;
            }
            
            h1 {
                font-size: 1.7em;
            }
            
            select, input, button {
                padding: 14px;
                font-size: 16px; /* Evita zoom autom√°tico en iOS */
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #00C4FF;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ff6b6b;
        }

        .success-message {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #51cf66;
        }

        .sync-info {
            background: rgba(0, 196, 255, 0.1);
            border: 1px solid #00C4FF;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        /* Estilos para el panel de administraci√≥n */
        .admin-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #00C4FF;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .admin-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 0.9em;
        }

        .backup-info {
            font-size: 0.8em;
            color: #cbd7ff;
            margin-top: 10px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            background: rgba(0, 123, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            border: 1px dashed #00C4FF;
            margin: 5px 0;
        }

        .file-label:hover {
            background: rgba(0, 123, 255, 0.3);
        }
    </style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="loadingText">Procesando...</p>
</div>

<div class="container">
    <h1>NeoStudy üöÄ</h1>
    <p>Tu educaci√≥n digital comienza aqu√≠</p>

    <!-- Informaci√≥n actualizada -->
    <div class="sync-info">
        üíæ <strong>Base de datos local activada</strong><br>
        Tus datos se guardar√°n de forma segura en tu dispositivo
    </div>

    <!-- Panel de administraci√≥n para exportar/importar -->
    <div class="admin-panel">
        <strong>üîÑ Gesti√≥n de Base de Datos</strong>
        <div class="admin-buttons">
            <button id="btnExport" style="background: linear-gradient(90deg, #28a745, #20c997);">üì§ Exportar BD</button>
            <button id="btnImport" style="background: linear-gradient(90deg, #ffc107, #fd7e14);">üì• Importar BD</button>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".json">
        <label for="fileInput" class="file-label" id="fileLabel">Seleccionar archivo de respaldo</label>
        <div class="backup-info">
            üí° <strong>Consejo:</strong> Exporta tu BD antes de cambiar de computadora
        </div>
    </div>

    <!-- Mensajes de estado -->
    <div id="messageContainer"></div>

    <!-- Selecci√≥n de categor√≠a -->
    <select id="categoria">
        <option value="">Selecciona tu categor√≠a</option>
        <option value="profesional">Profesional</option>
        <option value="universitario">Estudiante Universitario</option>
        <option value="secundaria">Alumno de Secundaria</option>
        <option value="general">P√∫blico en general</option>
    </select>

    <!-- Formularios din√°micos -->
    <form id="formProfesional" class="hidden">
        <input type="text" id="prof_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="prof_profesion" placeholder="Profesi√≥n" required>
        <input type="text" id="prof_carrera" placeholder="Carrera" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="prof_nacimiento" required>
        <input type="email" id="prof_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="prof_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formUniversitario" class="hidden">
        <input type="text" id="uni_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="uni_universidad" placeholder="Universidad" required>
        <input type="text" id="uni_carrera" placeholder="Carrera" required>
        <input type="text" id="uni_ciclo" placeholder="Ciclo/A√±o" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="uni_nacimiento" required>
        <input type="email" id="uni_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="uni_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formSecundaria" class="hidden">
        <input type="text" id="sec_nombre" placeholder="Nombre y Apellido" required>
        <input type="text" id="sec_colegio" placeholder="Colegio" required>
        <input type="text" id="sec_grado" placeholder="Grado/Secci√≥n" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="sec_nacimiento" required>
        <input type="email" id="sec_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="sec_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <form id="formGeneral" class="hidden">
        <input type="text" id="gen_nombre" placeholder="Nombre y Apellido" required>
        <label class="date-label">Fecha de nacimiento</label>
        <input type="date" id="gen_nacimiento" required>
        <input type="email" id="gen_email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="gen_password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <button type="submit">Crear Cuenta</button>
    </form>

    <h3>O Inicia Sesi√≥n</h3>
    <input type="email" id="login_email" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="login_password" placeholder="Contrase√±a" required>
    <button id="btnLogin">Iniciar Sesi√≥n</button>

    <div class="footer">
        ¬øNo tienes cuenta? <a id="btnCrearCuenta">Crea tu cuenta</a>
    </div>
</div>

<script>
// üîπ CONFIGURACI√ìN DE LA BASE DE DATOS LOCAL
class LocalDatabase {
    constructor() {
        this.dbName = 'NeoStudyDB';
        this.dbVersion = 2;
        this.db = null;
        this.init();
    }

    // Inicializar la base de datos
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => {
                console.error('‚ùå Error al abrir la base de datos:', request.error);
                reject(request.error);
            };
            
            request.onsuccess = () => {
                this.db = request.result;
                console.log('‚úÖ Base de datos local inicializada correctamente');
                resolve(this.db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Crear almac√©n de usuarios si no existe
                if (!db.objectStoreNames.contains('usuarios')) {
                    const userStore = db.createObjectStore('usuarios', { keyPath: 'id', autoIncrement: true });
                    userStore.createIndex('email', 'perfil.email', { unique: true });
                    userStore.createIndex('categoria', 'perfil.categoria', { unique: false });
                    console.log('‚úÖ Almac√©n de usuarios creado');
                }
                
                // Crear almac√©n de sesiones
                if (!db.objectStoreNames.contains('sesiones')) {
                    const sessionStore = db.createObjectStore('sesiones', { keyPath: 'id' });
                    console.log('‚úÖ Almac√©n de sesiones creado');
                }
                
                // Crear almac√©n de libros
                if (!db.objectStoreNames.contains('biblioteca')) {
                    const libraryStore = db.createObjectStore('biblioteca', { keyPath: 'id', autoIncrement: true });
                    libraryStore.createIndex('usuarioId', 'usuarioId', { unique: false });
                    console.log('‚úÖ Almac√©n de biblioteca creado');
                }

                // Crear almac√©n de configuraciones
                if (!db.objectStoreNames.contains('configuraciones')) {
                    const configStore = db.createObjectStore('configuraciones', { keyPath: 'id' });
                    console.log('‚úÖ Almac√©n de configuraciones creado');
                }
            };
        });
    }

    // M√©todo gen√©rico para realizar operaciones en la base de datos
    async execute(storeName, mode, operation) {
        if (!this.db) {
            await this.init();
        }
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], mode);
            const store = transaction.objectStore(storeName);
            
            transaction.oncomplete = () => resolve();
            transaction.onerror = () => reject(transaction.error);
            
            operation(store);
        });
    }

    // Guardar usuario
    async saveUser(userData) {
        try {
            await this.execute('usuarios', 'readwrite', (store) => {
                store.add(userData);
            });
            console.log('‚úÖ Usuario guardado en la base de datos local');
            return true;
        } catch (error) {
            console.error('‚ùå Error al guardar usuario:', error);
            return false;
        }
    }

    // Obtener usuario por email
    async getUserByEmail(email) {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                reject(new Error('Base de datos no inicializada'));
                return;
            }
            
            const transaction = this.db.transaction(['usuarios'], 'readonly');
            const store = transaction.objectStore('usuarios');
            const index = store.index('email');
            const request = index.get(email);
            
            request.onsuccess = () => {
                resolve(request.result);
            };
            
            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Obtener todos los usuarios
    async getAllUsers() {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                reject(new Error('Base de datos no inicializada'));
                return;
            }
            
            const transaction = this.db.transaction(['usuarios'], 'readonly');
            const store = transaction.objectStore('usuarios');
            const request = store.getAll();
            
            request.onsuccess = () => {
                resolve(request.result);
            };
            
            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Obtener todos los datos de una tabla
    async getAllData(storeName) {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                reject(new Error('Base de datos no inicializada'));
                return;
            }
            
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onsuccess = () => {
                resolve(request.result);
            };
            
            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Guardar sesi√≥n activa
    async saveSession(sessionData) {
        try {
            await this.execute('sesiones', 'readwrite', (store) => {
                store.put(sessionData);
            });
            console.log('‚úÖ Sesi√≥n guardada en la base de datos local');
            return true;
        } catch (error) {
            console.error('‚ùå Error al guardar sesi√≥n:', error);
            return false;
        }
    }

    // Obtener sesi√≥n activa
    async getActiveSession() {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                reject(new Error('Base de datos no inicializada'));
                return;
            }
            
            const transaction = this.db.transaction(['sesiones'], 'readonly');
            const store = transaction.objectStore('sesiones');
            const request = store.get('current');
            
            request.onsuccess = () => {
                resolve(request.result);
            };
            
            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Cerrar sesi√≥n
    async logout() {
        try {
            await this.execute('sesiones', 'readwrite', (store) => {
                store.delete('current');
            });
            console.log('‚úÖ Sesi√≥n cerrada correctamente');
            return true;
        } catch (error) {
            console.error('‚ùå Error al cerrar sesi√≥n:', error);
            return false;
        }
    }

    // Guardar libro en biblioteca
    async saveBook(bookData) {
        try {
            await this.execute('biblioteca', 'readwrite', (store) => {
                store.add(bookData);
            });
            console.log('‚úÖ Libro guardado en biblioteca local');
            return true;
        } catch (error) {
            console.error('‚ùå Error al guardar libro:', error);
            return false;
        }
    }

    // Obtener libros de un usuario
    async getUserBooks(userId) {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                reject(new Error('Base de datos no inicializada'));
                return;
            }
            
            const transaction = this.db.transaction(['biblioteca'], 'readonly');
            const store = transaction.objectStore('biblioteca');
            const index = store.index('usuarioId');
            const request = index.getAll(userId);
            
            request.onsuccess = () => {
                resolve(request.result);
            };
            
            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // üîπ NUEVAS FUNCIONES PARA EXPORTACI√ìN/IMPORTACI√ìN

    // Exportar toda la base de datos a un objeto JSON
    async exportDatabase() {
        try {
            showLoading("Exportando base de datos...");
            
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    version: this.dbVersion,
                    databaseName: this.dbName,
                    totalRecords: 0
                },
                data: {}
            };

            // Obtener todos los datos de cada almac√©n
            const storeNames = ['usuarios', 'sesiones', 'biblioteca', 'configuraciones'];
            
            for (const storeName of storeNames) {
                try {
                    const data = await this.getAllData(storeName);
                    exportData.data[storeName] = data;
                    exportData.metadata.totalRecords += data.length;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è No se pudo exportar ${storeName}:`, error);
                    exportData.data[storeName] = [];
                }
            }

            hideLoading();
            console.log('‚úÖ Base de datos exportada correctamente');
            return exportData;
        } catch (error) {
            hideLoading();
            console.error('‚ùå Error al exportar base de datos:', error);
            throw error;
        }
    }

    // Importar datos desde un objeto JSON
    async importDatabase(importData, merge = true) {
        try {
            showLoading("Importando base de datos...");
            
            if (!importData || !importData.data) {
                throw new Error('Formato de archivo inv√°lido');
            }

            let importedRecords = 0;
            const storeNames = ['usuarios', 'sesiones', 'biblioteca', 'configuraciones'];

            for (const storeName of storeNames) {
                if (importData.data[storeName]) {
                    console.log(`üîÑ Importando ${storeName}...`);
                    
                    // Limpiar el almac√©n si no estamos haciendo merge
                    if (!merge) {
                        await this.clearStore(storeName);
                    }

                    // Importar datos
                    for (const record of importData.data[storeName]) {
                        try {
                            await this.execute(storeName, 'readwrite', (store) => {
                                store.add(record);
                            });
                            importedRecords++;
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è No se pudo importar registro en ${storeName}:`, error);
                        }
                    }
                }
            }

            hideLoading();
            console.log(`‚úÖ Base de datos importada: ${importedRecords} registros`);
            return importedRecords;
        } catch (error) {
            hideLoading();
            console.error('‚ùå Error al importar base de datos:', error);
            throw error;
        }
    }

    // Limpiar un almac√©n espec√≠fico
    async clearStore(storeName) {
        try {
            await this.execute(storeName, 'readwrite', (store) => {
                store.clear();
            });
            console.log(`‚úÖ Almac√©n ${storeName} limpiado`);
            return true;
        } catch (error) {
            console.error(`‚ùå Error al limpiar ${storeName}:`, error);
            return false;
        }
    }

    // Obtener estad√≠sticas de la base de datos
    async getDatabaseStats() {
        const stats = {};
        const storeNames = ['usuarios', 'sesiones', 'biblioteca', 'configuraciones'];
        
        for (const storeName of storeNames) {
            try {
                const data = await this.getAllData(storeName);
                stats[storeName] = data.length;
            } catch (error) {
                stats[storeName] = 0;
            }
        }
        
        return stats;
    }
}

// üîπ INICIALIZAR BASE DE DATOS
const localDB = new LocalDatabase();

// üîπ ELEMENTOS DEL DOM
const categoriaSelect = document.getElementById("categoria");
const messageContainer = document.getElementById("messageContainer");
const loadingElement = document.getElementById("loading");
const loadingText = document.getElementById("loadingText");
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileInput = document.getElementById("fileInput");
const fileLabel = document.getElementById("fileLabel");

const forms = {
    profesional: document.getElementById("formProfesional"),
    universitario: document.getElementById("formUniversitario"),
    secundaria: document.getElementById("formSecundaria"),
    general: document.getElementById("formGeneral")
};

// üîπ FUNCIONES DE UTILIDAD
function showLoading(text = "Procesando...") {
    loadingText.textContent = text;
    loadingElement.style.display = 'flex';
}

function hideLoading() {
    loadingElement.style.display = 'none';
}

function showMessage(message, type = 'error') {
    messageContainer.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
    setTimeout(() => {
        messageContainer.innerHTML = '';
    }, 5000);
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function generateUserId() {
    return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// üîπ FUNCIONES DE EXPORTACI√ìN/IMPORTACI√ìN

// Exportar base de datos a archivo JSON
async function exportDatabase() {
    try {
        showLoading("Preparando exportaci√≥n...");
        
        // Obtener estad√≠sticas antes de exportar
        const stats = await localDB.getDatabaseStats();
        const totalRecords = Object.values(stats).reduce((a, b) => a + b, 0);
        
        if (totalRecords === 0) {
            hideLoading();
            showMessage("‚ÑπÔ∏è No hay datos para exportar");
            return;
        }

        // Exportar datos
        const exportData = await localDB.exportDatabase();
        
        // Crear y descargar archivo
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        
        // Nombre del archivo con fecha
        const date = new Date().toISOString().split('T')[0];
        link.download = `neostudy_backup_${date}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        hideLoading();
        showMessage(`‚úÖ Base de datos exportada correctamente (${totalRecords} registros)`, 'success');
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Error en exportaci√≥n:', error);
        showMessage('‚ùå Error al exportar base de datos: ' + error.message);
    }
}

// Importar base de datos desde archivo JSON
async function importDatabase(file) {
    try {
        if (!file) {
            showMessage("‚ùå Por favor selecciona un archivo");
            return;
        }

        if (!file.name.endsWith('.json')) {
            showMessage("‚ùå El archivo debe ser un JSON v√°lido");
            return;
        }

        showLoading("Leyendo archivo...");
        
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            try {
                const importData = JSON.parse(e.target.result);
                
                // Validar formato del archivo
                if (!importData.metadata || !importData.data) {
                    throw new Error('Formato de archivo inv√°lido');
                }
                
                // Mostrar confirmaci√≥n
                const totalRecords = Object.values(importData.data).flat().length;
                const confirmMessage = `¬øEst√°s seguro de importar ${totalRecords} registros?\n\nEsta acci√≥n no se puede deshacer.`;
                
                if (!confirm(confirmMessage)) {
                    hideLoading();
                    return;
                }
                
                // Importar datos (sin merge para evitar duplicados)
                const importedCount = await localDB.importDatabase(importData, false);
                
                hideLoading();
                showMessage(`‚úÖ Base de datos importada correctamente (${importedCount} registros)`, 'success');
                
                // Limpiar input de archivo
                fileInput.value = '';
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Error al procesar archivo:', error);
                showMessage('‚ùå Error al importar: ' + error.message);
            }
        };
        
        reader.onerror = () => {
            hideLoading();
            showMessage('‚ùå Error al leer el archivo');
        };
        
        reader.readAsText(file);
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Error en importaci√≥n:', error);
        showMessage('‚ùå Error al importar base de datos: ' + error.message);
    }
}

// üîπ EVENT LISTENERS PARA EXPORTACI√ìN/IMPORTACI√ìN
btnExport.addEventListener('click', exportDatabase);

btnImport.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        fileLabel.textContent = `Archivo seleccionado: ${file.name}`;
        importDatabase(file);
    }
});

// üîπ INICIALIZAR DATOS DE USUARIO
function initializeUserData(userData) {
    console.log("üîÑ Inicializando datos del usuario...");
    
    // Crear estructura inicial de datos del usuario
    const userStructure = {
        id: generateUserId(),
        // Perfil del usuario
        perfil: {
            nombre: userData.nombre,
            email: userData.email,
            categoria: userData.categoria,
            fechaNacimiento: userData.fechaNacimiento,
            fechaRegistro: new Date().toISOString(),
            fotoPerfil: "", // URL de la foto de perfil
            tema: "claro" // Preferencia de tema
        },
        
        // Libros comprados
        biblioteca: {
            librosComprados: [],
            favoritos: [],
            ultimaLectura: null,
            progresoGlobal: 0
        },
        
        // Configuraciones
        configuraciones: {
            notificaciones: true,
            sincronizacionAuto: true,
            idioma: "es",
            modoOffline: false
        },
        
        // Datos de aprendizaje
        progreso: {
            cursosCompletados: 0,
            horasEstudiadas: 0,
            logros: [],
            puntos: 0
        },
        
        // Dispositivos conectados
        dispositivos: [{
            tipo: navigator.userAgent.includes('Mobile') ? 'movil' : 'escritorio',
            ultimaConexion: new Date().toISOString(),
            id: generateDeviceId()
        }]
    };

    // Agregar campos espec√≠ficos por categor√≠a
    if (userData.categoria === 'profesional') {
        userStructure.perfil.profesion = userData.profesion;
        userStructure.perfil.carrera = userData.carrera;
    } else if (userData.categoria === 'universitario') {
        userStructure.perfil.universidad = userData.universidad;
        userStructure.perfil.carrera = userData.carrera;
        userStructure.perfil.ciclo = userData.ciclo;
    } else if (userData.categoria === 'secundaria') {
        userStructure.perfil.colegio = userData.colegio;
        userStructure.perfil.grado = userData.grado;
    }

    console.log("‚úÖ Datos de usuario inicializados correctamente");
    return userStructure;
}

// Generar ID √∫nico para el dispositivo
function generateDeviceId() {
    return 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// üîπ MOSTRAR FORMULARIOS SEG√öN CATEGOR√çA
document.getElementById("btnCrearCuenta").addEventListener("click", function() {
    categoriaSelect.scrollIntoView({ behavior: 'smooth' });
    categoriaSelect.focus();
    showMessage("Por favor selecciona tu categor√≠a para crear tu cuenta", 'success');
});

categoriaSelect.addEventListener("change", () => {
    const value = categoriaSelect.value;
    Object.values(forms).forEach(f => f.classList.add("hidden"));
    if(value && forms[value]) forms[value].classList.remove("hidden");
});

// üîπ CREAR CUENTA CON BASE DE DATOS LOCAL
async function saveUser(form, category) {
    try {
        showLoading("Creando tu cuenta...");
        
        const inputs = form.querySelectorAll('input');
        let email = '';
        let password = '';
        let userData = { 
            categoria: category,
            fechaRegistro: new Date().toISOString()
        };

        // Recoger todos los datos del formulario
        inputs.forEach(input => {
            if (input.type !== 'submit') {
                userData[input.id] = input.value;
                
                if (input.type === 'email') {
                    email = input.value.trim().toLowerCase();
                }
                if (input.type === 'password') {
                    password = input.value;
                }
                if (input.type === 'date') {
                    userData.fechaNacimiento = input.value;
                }
            }
        });

        // Validaciones
        if (!email || !password) {
            hideLoading();
            showMessage("Por favor ingresa un correo y contrase√±a v√°lidos");
            return;
        }

        if (!isValidEmail(email)) {
            hideLoading();
            showMessage("Por favor ingresa un correo electr√≥nico v√°lido");
            return;
        }

        if (password.length < 6) {
            hideLoading();
            showMessage("La contrase√±a debe tener al menos 6 caracteres");
            return;
        }

        console.log("üìù Intentando crear usuario:", email);

        // Verificar si el usuario ya existe
        const existingUser = await localDB.getUserByEmail(email);
        if (existingUser) {
            hideLoading();
            showMessage("‚ùå Este correo ya est√° registrado. Por favor inicia sesi√≥n.");
            return;
        }

        // PREPARAR DATOS PARA INICIALIZACI√ìN
        const userProfile = {
            nombre: userData.prof_nombre || userData.uni_nombre || userData.sec_nombre || userData.gen_nombre,
            email: email,
            categoria: category,
            fechaNacimiento: userData.fechaNacimiento,
            password: password // En un caso real, esto deber√≠a estar hasheado
        };

        // Agregar campos espec√≠ficos por categor√≠a
        if (category === 'profesional') {
            userProfile.profesion = userData.prof_profesion;
            userProfile.carrera = userData.prof_carrera;
        } else if (category === 'universitario') {
            userProfile.universidad = userData.uni_universidad;
            userProfile.carrera = userData.uni_carrera;
            userProfile.ciclo = userData.uni_ciclo;
        } else if (category === 'secundaria') {
            userProfile.colegio = userData.sec_colegio;
            userProfile.grado = userData.sec_grado;
        }

        // INICIALIZAR DATOS EN LA BASE DE DATOS LOCAL
        showLoading("Configurando tu perfil...");
        const userStructure = initializeUserData(userProfile);
        
        // Guardar usuario en la base de datos
        await localDB.saveUser(userStructure);

        // Crear sesi√≥n autom√°ticamente
        await localDB.saveSession({
            id: 'current',
            userId: userStructure.id,
            email: email,
            loginTime: new Date().toISOString(),
            isActive: true
        });

        hideLoading();
        showMessage("‚úÖ Cuenta creada con √©xito. Tus datos se guardar√°n en tu dispositivo!", 'success');
        
        // Limpiar formulario
        form.reset();
        
        // Redirigir despu√©s de 2 segundos
        setTimeout(() => {
            window.location.href = "modulo2_iniciodecesi√≥n.html";
        }, 2000);

    } catch (error) {
        hideLoading();
        console.error("‚ùå Error completo:", error);
        showMessage("‚ùå Error al crear cuenta: " + error.message);
    }
}

// üîπ INICIAR SESI√ìN CON BASE DE DATOS LOCAL
document.getElementById("btnLogin").addEventListener("click", async () => {
    const email = document.getElementById("login_email").value.trim().toLowerCase();
    const password = document.getElementById("login_password").value;
    
    if (!email || !password) {
        showMessage("Por favor completa todos los campos");
        return;
    }

    if (!isValidEmail(email)) {
        showMessage("Por favor ingresa un correo electr√≥nico v√°lido");
        return;
    }

    try {
        showLoading("Iniciando sesi√≥n...");
        console.log("üîê Intentando iniciar sesi√≥n:", email);
        
        // Buscar usuario por email
        const user = await localDB.getUserByEmail(email);
        
        if (!user) {
            hideLoading();
            showMessage("‚ùå No existe una cuenta con este correo. Por favor crea una cuenta primero.");
            return;
        }

        // Verificar contrase√±a (en un caso real, esto deber√≠a ser con hash)
        if (user.perfil.password !== password) {
            hideLoading();
            showMessage("‚ùå Contrase√±a incorrecta. Intenta nuevamente.");
            return;
        }

        console.log("‚úÖ Sesi√≥n iniciada para:", user.perfil.email);

        // ACTUALIZAR DISPOSITIVO EN LA BASE DE DATOS
        showLoading("Cargando tus datos...");
        const deviceInfo = {
            tipo: navigator.userAgent.includes('Mobile') ? 'movil' : 'escritorio',
            ultimaConexion: new Date().toISOString(),
            id: generateDeviceId()
        };

        // Actualizar dispositivo (en una implementaci√≥n real, esto actualizar√≠a el usuario)
        user.dispositivos.push(deviceInfo);
        await localDB.saveUser(user);

        // Crear sesi√≥n
        await localDB.saveSession({
            id: 'current',
            userId: user.id,
            email: email,
            loginTime: new Date().toISOString(),
            isActive: true
        });

        hideLoading();
        showMessage("‚úÖ Inicio de sesi√≥n exitoso. Cargando tus datos...", 'success');
        
        // Limpiar campos de login
        document.getElementById('login_email').value = '';
        document.getElementById('login_password').value = '';
        
        // Redirigir despu√©s de 1 segundo
        setTimeout(() => {
            window.location.href = "modulo2_iniciodecesi√≥n.html";
        }, 1000);

    } catch (error) {
        hideLoading();
        console.error("‚ùå Error de login:", error);
        showMessage("‚ùå Error al iniciar sesi√≥n: " + error.message);
    }
});

// üîπ ASIGNAR EVENTOS A LOS FORMULARIOS
Object.keys(forms).forEach(cat => {
    forms[cat].addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveUser(forms[cat], cat);
    });
});

// üîπ VERIFICAR SI HAY UNA SESI√ìN ACTIVA AL CARGAR LA P√ÅGINA
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const activeSession = await localDB.getActiveSession();
        if (activeSession && activeSession.isActive) {
            console.log("üë§ Sesi√≥n activa encontrada:", activeSession.email);
            // Opcional: redirigir autom√°ticamente si ya est√° logueado
            // window.location.href = "modulo2_iniciodecesi√≥n.html";
        } else {
            console.log("üîí No hay sesi√≥n activa");
        }
    } catch (error) {
        console.log("üîí No hay sesi√≥n activa o error al verificar:", error);
    }
});

// üîπ FUNCIONES PARA LA BIBLIOTECA (para usar en otros m√≥dulos)
window.guardarLibroComprado = async function(libroData) {
    try {
        const activeSession = await localDB.getActiveSession();
        if (!activeSession) return false;

        const bookWithUser = {
            ...libroData,
            usuarioId: activeSession.userId,
            fechaCompra: new Date().toISOString()
        };

        await localDB.saveBook(bookWithUser);
        
        console.log("‚úÖ Libro guardado en la biblioteca local:", libroData.titulo);
        return true;
    } catch (error) {
        console.error("‚ùå Error al guardar libro:", error);
        return false;
    }
};

window.guardarFotoPerfil = async function(fotoUrl) {
    try {
        const activeSession = await localDB.getActiveSession();
        if (!activeSession) return false;

        const user = await localDB.getUserByEmail(activeSession.email);
        if (!user) return false;

        user.perfil.fotoPerfil = fotoUrl;
        await localDB.saveUser(user);
        
        console.log("‚úÖ Foto de perfil guardada en la base de datos local");
        return true;
    } catch (error) {
        console.error("‚ùå Error al guardar foto:", error);
        return false;
    }
};

window.cargarDatosUsuario = async function() {
    try {
        const activeSession = await localDB.getActiveSession();
        if (!activeSession) return null;

        const user = await localDB.getUserByEmail(activeSession.email);
        if (user) {
            console.log("‚úÖ Datos cargados desde la base de datos local");
            return user;
        }
        return null;
    } catch (error) {
        console.error("‚ùå Error al cargar datos:", error);
        return null;
    }
};

window.cerrarSesion = async function() {
    try {
        await localDB.logout();
        console.log("‚úÖ Sesi√≥n cerrada correctamente");
        return true;
    } catch (error) {
        console.error("‚ùå Error al cerrar sesi√≥n:", error);
        return false;
    }
};

window.obtenerLibrosUsuario = async function() {
    try {
        const activeSession = await localDB.getActiveSession();
        if (!activeSession) return [];

        const books = await localDB.getUserBooks(activeSession.userId);
        console.log("‚úÖ Libros cargados desde la biblioteca local");
        return books;
    } catch (error) {
        console.error("‚ùå Error al cargar libros:", error);
        return [];
    }
};

// üîπ NUEVAS FUNCIONES GLOBALES PARA EXPORTACI√ìN/IMPORTACI√ìN
window.exportarBaseDatos = exportDatabase;
window.importarBaseDatos = importDatabase;
window.obtenerEstadisticasBD = async function() {
    return await localDB.getDatabaseStats();
};

console.log("üíæ Sistema de base de datos local + exportaci√≥n activado");
console.log("üì§ Puedes exportar e importar tu base de datos entre computadoras");
</script>
</body>
</html>
