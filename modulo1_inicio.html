<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeoStudy - Crear Cuenta / Iniciar Sesi√≥n</title>
<style>
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    overflow-x: hidden;
    background: linear-gradient(120deg, #001F3F, #003366, #00C4FF);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    padding: 20px;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .container {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 30px;
    width: 100%;
    max-width: 450px;
    text-align: center;
    box-shadow: 0 0 30px rgba(0,0,0,0.4);
  }

  h1 { 
    color: #00C4FF; 
    font-size: 2em; 
    margin-bottom: 15px; 
  }
  
  p { 
    font-size: 1em; 
    color: #dfe9ff; 
    margin-bottom: 25px; 
  }

  select, input, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: none;
    font-size: 1em;
  }

  input { 
    background: rgba(255,255,255,0.9); 
    color: #333; 
  }
  
  input:focus { 
    outline: none; 
    box-shadow: 0 0 12px #00C4FF; 
    transform: scale(1.03); 
  }

  button {
    background: linear-gradient(90deg,#00C4FF,#007bff);
    color: white;
    cursor: pointer;
    margin-top: 10px;
    box-shadow: 0 0 15px #00C4FF;
    transition: 0.3s;
  }

  button:hover { 
    transform: scale(1.05); 
    box-shadow: 0 0 25px #00FFFF; 
  }

  .footer { 
    margin-top: 15px; 
    font-size: 0.9em; 
    color: #cbd7ff; 
  }
  
  .footer a { 
    color: #00C4FF; 
    text-decoration: none; 
    cursor: pointer;
    font-weight: bold;
  }
  
  .footer a:hover { 
    text-decoration: underline; 
  }

  .hidden { 
    display: none; 
  }
  
  .date-label {
    display: block;
    text-align: left;
    margin: 10px 0 5px;
    color: #dfe9ff;
    font-size: 0.9em;
  }

  .instruction {
    color: #00C4FF;
    font-size: 0.9em;
    margin: 10px 0;
    font-style: italic;
  }

  .contact-type {
    display: flex;
    gap: 10px;
    margin: 10px 0;
  }

  .contact-option {
    flex: 1;
    padding: 10px;
    background: rgba(255,255,255,0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .contact-option.selected {
    background: #00C4FF;
    color: white;
  }

  .contact-option input {
    display: none;
  }
  
  @media (max-width: 480px) {
    body {
      padding: 10px;
      align-items: flex-start;
    }
    
    .container {
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }
    
    h1 {
      font-size: 1.7em;
    }
    
    select, input, button {
      padding: 14px;
      font-size: 16px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>NeoStudy üöÄ</h1>
  <p>Tu educaci√≥n digital comienza aqu√≠</p>

  <select id="categoria">
    <option value="">Selecciona tu categor√≠a</option>
    <option value="profesional">Profesional</option>
    <option value="universitario">Estudiante Universitario</option>
    <option value="secundaria">Alumno de Secundaria</option>
    <option value="general">P√∫blico en general</option>
  </select>

  <div id="instructionMessage" class="instruction hidden">
    Por favor completa todos los campos del formulario
  </div>

  <form id="formProfesional" class="hidden">
    <input type="text" id="prof_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="prof_profesion" placeholder="Profesi√≥n" required>
    <input type="text" id="prof_carrera" placeholder="Carrera" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="prof_nacimiento" required>
    
    <label class="date-label">Tipo de contacto:</label>
    <div class="contact-type">
      <label class="contact-option" id="prof_email_option">
        <input type="radio" name="prof_contact_type" value="email" checked> 
        Correo Electr√≥nico
      </label>
      <label class="contact-option" id="prof_phone_option">
        <input type="radio" name="prof_contact_type" value="phone">
        Tel√©fono
      </label>
    </div>
    <input type="text" id="prof_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="prof_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formUniversitario" class="hidden">
    <input type="text" id="uni_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="uni_universidad" placeholder="Universidad" required>
    <input type="text" id="uni_carrera" placeholder="Carrera" required>
    <input type="text" id="uni_ciclo" placeholder="Ciclo/A√±o" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="uni_nacimiento" required>
    
    <label class="date-label">Tipo de contacto:</label>
    <div class="contact-type">
      <label class="contact-option" id="uni_email_option">
        <input type="radio" name="uni_contact_type" value="email" checked> 
        Correo Electr√≥nico
      </label>
      <label class="contact-option" id="uni_phone_option">
        <input type="radio" name="uni_contact_type" value="phone">
        Tel√©fono
      </label>
    </div>
    <input type="text" id="uni_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="uni_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formSecundaria" class="hidden">
    <input type="text" id="sec_nombre" placeholder="Nombre y Apellido" required>
    <input type="text" id="sec_colegio" placeholder="Colegio" required>
    <input type="text" id="sec_grado" placeholder="Grado/Secci√≥n" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="sec_nacimiento" required>
    
    <label class="date-label">Tipo de contacto:</label>
    <div class="contact-type">
      <label class="contact-option" id="sec_email_option">
        <input type="radio" name="sec_contact_type" value="email" checked> 
        Correo Electr√≥nico
      </label>
      <label class="contact-option" id="sec_phone_option">
        <input type="radio" name="sec_contact_type" value="phone">
        Tel√©fono
      </label>
    </div>
    <input type="text" id="sec_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="sec_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <form id="formGeneral" class="hidden">
    <input type="text" id="gen_nombre" placeholder="Nombre y Apellido" required>
    <label class="date-label">Fecha de nacimiento</label>
    <input type="date" id="gen_nacimiento" required>
    
    <label class="date-label">Tipo de contacto:</label>
    <div class="contact-type">
      <label class="contact-option" id="gen_email_option">
        <input type="radio" name="gen_contact_type" value="email" checked> 
        Correo Electr√≥nico
      </label>
      <label class="contact-option" id="gen_phone_option">
        <input type="radio" name="gen_contact_type" value="phone">
        Tel√©fono
      </label>
    </div>
    <input type="text" id="gen_contacto" placeholder="Correo Electr√≥nico" required>
    <input type="password" id="gen_password" placeholder="Contrase√±a" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <h3>O Inicia Sesi√≥n</h3>
  
  <label class="date-label">Tipo de contacto:</label>
  <div class="contact-type">
    <label class="contact-option" id="login_email_option">
      <input type="radio" name="login_contact_type" value="email" checked> 
      Correo Electr√≥nico
    </label>
    <label class="contact-option" id="login_phone_option">
      <input type="radio" name="login_contact_type" value="phone">
      Tel√©fono
    </label>
  </div>
  
  <input type="text" id="login_contacto" placeholder="Correo Electr√≥nico">
  <input type="password" id="login_password" placeholder="Contrase√±a">
  <button id="btnLogin">Iniciar Sesi√≥n</button>

  <div class="footer">
    ¬øNo tienes cuenta? <a id="btnCrearCuenta">Crea tu cuenta</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// CONFIGURACI√ìN DE SUPABASE - REEMPLAZA ESTOS VALORES
// ============================================

const SUPABASE_URL = "https://qmzoblunltlathycycaw.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtem9ibHVubHRsYXRoeWN5Y2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzM4MDcsImV4cCI6MjA3OTkwOTgwN30.1n3A41f5HPg2QfNBOESH1xLgAl-MNX7-_R97M8NsRnA"; 

// ============================================
// NO MODIFICAR NADA DEBAJO DE ESTA L√çNEA
// ============================================

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const categoriaSelect = document.getElementById("categoria");
const instructionMessage = document.getElementById("instructionMessage");
const forms = {
  profesional: document.getElementById("formProfesional"),
  universitario: document.getElementById("formUniversitario"),
  secundaria: document.getElementById("formSecundaria"),
  general: document.getElementById("formGeneral")
};

function setupContactOptions() {
  const contactOptions = [
    { email: 'prof_email_option', phone: 'prof_phone_option', input: 'prof_contacto' },
    { email: 'uni_email_option', phone: 'uni_phone_option', input: 'uni_contacto' },
    { email: 'sec_email_option', phone: 'sec_phone_option', input: 'sec_contacto' },
    { email: 'gen_email_option', phone: 'gen_phone_option', input: 'gen_contacto' }
  ];

  contactOptions.forEach(option => {
    const emailOpt = document.getElementById(option.email);
    const phoneOpt = document.getElementById(option.phone);
    const input = document.getElementById(option.input);

    if (emailOpt && phoneOpt && input) {
      emailOpt.addEventListener('click', () => {
        emailOpt.classList.add('selected');
        phoneOpt.classList.remove('selected');
        input.placeholder = "Correo Electr√≥nico";
        input.type = "email";
      });

      phoneOpt.addEventListener('click', () => {
        phoneOpt.classList.add('selected');
        emailOpt.classList.remove('selected');
        input.placeholder = "N√∫mero de Tel√©fono";
        input.type = "tel";
      });
      emailOpt.classList.add('selected');
    }
  });

  const loginEmail = document.getElementById('login_email_option');
  const loginPhone = document.getElementById('login_phone_option');
  const loginInput = document.getElementById('login_contacto');

  if (loginEmail && loginPhone && loginInput) {
    loginEmail.addEventListener('click', () => {
      loginEmail.classList.add('selected');
      loginPhone.classList.remove('selected');
      loginInput.placeholder = "Correo Electr√≥nico";
      loginInput.type = "email";
    });

    loginPhone.addEventListener('click', () => {
      loginPhone.classList.add('selected');
      loginEmail.classList.remove('selected');
      loginInput.placeholder = "N√∫mero de Tel√©fono";
      loginInput.type = "tel";
    });
    loginEmail.classList.add('selected');
  }
}

document.getElementById("btnCrearCuenta").addEventListener("click", function() {
  categoriaSelect.scrollIntoView({ behavior: 'smooth' });
  categoriaSelect.focus();
  alert("Por favor selecciona tu categor√≠a para crear tu cuenta");
});

categoriaSelect.addEventListener("change", () => {
  const value = categoriaSelect.value;
  
  Object.values(forms).forEach(f => f.classList.add("hidden"));
  instructionMessage.classList.add("hidden");
  
  if(value && forms[value]) {
    forms[value].classList.remove("hidden");
    instructionMessage.classList.remove("hidden");
    
    const firstInput = forms[value].querySelector('input');
    if (firstInput) {
      setTimeout(() => firstInput.focus(), 300);
    }
  }
});

function validarContacto(contacto, tipo) {
  if (tipo === 'email') {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(contacto);
  } else if (tipo === 'phone') {
    const phoneRegex = /^[0-9]{9,15}$/;
    return phoneRegex.test(contacto.replace(/\D/g, ''));
  }
  return false;
}

// FUNCI√ìN CORREGIDA PARA EVITAR ERROR RLS
async function saveUser(form, category) {
  try {
    const formData = new FormData(form);
    const data = { categoria: category };
    
    Array.from(form.elements).forEach(input => {
      if(input.type !== "submit" && input.name !== "contact_type") {
        data[input.id] = input.value;
        if (input.id.includes("nacimiento")) {
          data.fechaNacimiento = input.value;
        }
      }
    });
    
    const contactType = form.querySelector('input[name$="contact_type"]:checked').value;
    const contacto = data.prof_contacto || data.uni_contacto || data.sec_contacto || data.gen_contacto;
    const password = data.prof_password || data.uni_password || data.sec_password || data.gen_password;
    
    if (!validarContacto(contacto, contactType)) {
      alert(contactType === 'email' 
        ? "Por favor ingresa un correo electr√≥nico v√°lido" 
        : "Por favor ingresa un n√∫mero de tel√©fono v√°lido (9-15 d√≠gitos)");
      return;
    }
    
    if (!password || password.length < 6) {
      alert("La contrase√±a debe tener al menos 6 caracteres");
      return;
    }
    
    if (!data.fechaNacimiento) {
      data.fechaNacimiento = data.prof_nacimiento || data.uni_nacimiento || data.sec_nacimiento || data.gen_nacimiento;
    }
    
    // REGISTRO CON EMAIL (CORREGIDO)
    let userId;
    let userEmail = contacto;
    
    if (contactType === 'phone') {
      userEmail = `tel_${contacto.replace(/\D/g, '')}@neostudy.app`;
    }

    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: userEmail,
      password: password,
    });
    
    if (authError) throw new Error(authError.message);
    if (!authData.user) throw new Error("No se pudo crear el usuario");
    
    userId = authData.user.id;

    // PREPARAR DATOS DEL PERFIL - INCLUYENDO EL ID DEL USUARIO
    const profileData = {
      id: userId,  // ‚Üê ESTE ES EL CAMPO CLAVE QUE FALTABA
      nombre: data.prof_nombre || data.uni_nombre || data.sec_nombre || data.gen_nombre,
      categoria: category,
      fecha_nacimiento: data.fechaNacimiento,
      tipo_contacto: contactType,
      profesion: data.prof_profesion || null,
      carrera: data.prof_carrera || data.uni_carrera || null,
      universidad: data.uni_universidad || null,
      ciclo: data.uni_ciclo || null,
      colegio: data.sec_colegio || null,
      grado: data.sec_grado || null,
      created_at: new Date()
    };

    // Asignar contacto seg√∫n el tipo
    if (contactType === 'email') {
      profileData.email = contacto;
      profileData.telefono = null;
    } else {
      profileData.telefono = contacto;
      profileData.email = null;
    }

    // INSERTAR PERFIL CON EL ID CORRECTO
    const { error: profileError } = await supabase
      .from('profiles')
      .insert([profileData]);
    
    if (profileError) throw new Error(profileError.message);
    
    alert("Cuenta creada con √©xito ‚úÖ");
    window.location.href = "modulo2_iniciodecesi√≥n.html";
    
  } catch (error) {
    console.error("Error al crear cuenta:", error);
    alert("Error al crear cuenta: " + error.message);
  }
}

Object.keys(forms).forEach(cat => {
  forms[cat].addEventListener("submit", e => {
    e.preventDefault();
    saveUser(forms[cat], cat);
  });
});

document.getElementById("btnLogin").addEventListener("click", async () => {
  try {
    const contactType = document.querySelector('input[name="login_contact_type"]:checked').value;
    const contacto = document.getElementById("login_contacto").value;
    const password = document.getElementById("login_password").value;
    
    if (!contacto || !password) {
      alert("Por favor completa todos los campos");
      return;
    }

    if (!validarContacto(contacto, contactType)) {
      alert(contactType === 'email' 
        ? "Por favor ingresa un correo electr√≥nico v√°lido" 
        : "Por favor ingresa un n√∫mero de tel√©fono v√°lido");
      return;
    }

    let userEmail = contacto;
    if (contactType === 'phone') {
      userEmail = `tel_${contacto.replace(/\D/g, '')}@neostudy.app`;
    }

    const { data, error } = await supabase.auth.signInWithPassword({
      email: userEmail,
      password: password
    });

    if (error) throw new Error(error.message);

    if (data.user) {
      alert("Inicio de sesi√≥n exitoso ‚úÖ");
      window.location.href = "modulo2_iniciodecesi√≥n.html";
    }
    
  } catch (error) {
    console.error("Error al iniciar sesi√≥n:", error);
    alert("Error al iniciar sesi√≥n: " + error.message);
  }
});

document.addEventListener('DOMContentLoaded', function() {
  setupContactOptions();
});

function formatearFecha(fechaISO) {
  if (!fechaISO) return "";
  const fecha = new Date(fechaISO);
  const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
  return fecha.toLocaleDateString('es-ES', opciones);
}
</script>
</body>
</html>
