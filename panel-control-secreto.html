<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Control Neo Study - Premium</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #00C4FF;
            --primary-dark: #007bff;
            --success: #00b09b;
            --warning: #ff9800;
            --danger: #ff4b2b;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-light: #ffffff;
            --text-muted: #adb5bd;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 196, 255, 0.3);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        h2 {
            margin: 25px 0 15px 0;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 196, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 196, 255, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff416c);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #96c93d);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff5722);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .create-code-form {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: 2px solid var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 196, 255, 0.3);
            background: white;
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .search-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .filter-select {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            min-width: 150px;
        }
        
        .codigo {
            background: var(--card-bg);
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .codigo:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .usado {
            border-left-color: var(--success);
            background: rgba(0, 176, 155, 0.15);
        }
        
        .disponible {
            border-left-color: var(--warning);
            background: rgba(255, 152, 0, 0.15);
        }

        .bloqueado {
            border-left-color: var(--danger);
            background: rgba(255, 75, 43, 0.15);
        }
        
        .codigo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }

        .codigo-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-light);
        }
        
        .codigo-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .user-info {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-top: 8px;
            line-height: 1.5;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .user-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timestamp {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .price-tag {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-activo {
            background: var(--success);
            color: white;
        }

        .status-bloqueado {
            background: var(--danger);
            color: white;
        }

        .status-usado {
            background: var(--warning);
            color: white;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .section {
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .loading-spinner {
            border: 3px solid rgba(0, 196, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .success-msg {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .warning-msg {
            background: var(--warning);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .info-msg {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .sync-online {
            color: var(--success);
        }

        .sync-offline {
            color: var(--warning);
        }

        .sync-error {
            color: var(--danger);
        }

        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .sync-indicator.online {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .sync-indicator.offline {
            background: var(--warning);
        }

        .sync-indicator.error {
            background: var(--danger);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
        }

        .pagination-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn.active {
            background: var(--primary);
        }

        .pagination-btn:hover:not(.disabled) {
            background: var(--primary);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input, .filter-select {
                min-width: 100%;
            }
            
            .codigo-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .user-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ PANEL CONTROL NEO STUDY</h1>
            <p class="subtitle">Sistema de Gesti√≥n de C√≥digos Premium - V3.1</p>
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator" id="syncIndicator"></span>
                <span id="syncText">Conectando...</span>
                <span id="lastSync" style="margin-left: 15px; font-size: 0.8rem; color: var(--text-muted);"></span>
            </div>
        </div>
        
        <div class="dashboard">
            <div>
                <div class="stats" id="stats">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Cargando estad√≠sticas...
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button onclick="cargarDatos()" class="btn">
                        <i class="fas fa-sync-alt"></i> ACTUALIZAR
                    </button>
                    <button onclick="verUsuarios()" class="btn btn-secondary">
                        <i class="fas fa-users"></i> VER USUARIOS
                    </button>
                    <button onclick="verCodigosEliminados()" class="btn btn-danger">
                        <i class="fas fa-ban"></i> ACCESOS REVOCADOS
                    </button>
                    <button onclick="verCodigos()" class="btn">
                        <i class="fas fa-key"></i> TODOS LOS C√ìDIGOS
                    </button>
                    <button onclick="generarCodigos()" class="btn btn-success">
                        <i class="fas fa-plus"></i> GENERAR 5 C√ìDIGOS
                    </button>
                    <button onclick="probarConexion()" class="btn btn-warning">
                        <i class="fas fa-wifi"></i> PROBAR CONEXI√ìN
                    </button>
                    <button onclick="forzarSincronizacion()" class="btn btn-success">
                        <i class="fas fa-cloud-upload-alt"></i> SINCRONIZAR
                    </button>
                    <!-- NUEVO BOT√ìN PARA ASIGNAR C√ìDIGOS -->
                    <button onclick="asignarCodigoAUsuario()" class="btn btn-success">
                        <i class="fas fa-user-check"></i> ASIGNAR C√ìDIGO
                    </button>
                    <!-- NUEVO BOT√ìN PARA VERIFICAR NOTIFICACIONES PENDIENTES -->
                    <button onclick="verificarAsignacionesPendientes()" class="btn btn-warning">
                        <i class="fas fa-bell"></i> NOTIFICACIONES PENDIENTES
                    </button>
                </div>
            </div>
            
            <div class="create-code-form">
                <div class="form-title">
                    <i class="fas fa-plus-circle"></i>
                    <h2>CREAR C√ìDIGO MANUAL</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nuevoCodigo" class="form-label">
                            <i class="fas fa-key"></i> C√ìDIGO:
                        </label>
                        <input type="text" id="nuevoCodigo" class="form-input" 
                               placeholder="Ej: MATH7X9, STUDY4K3" maxlength="10"
                               pattern="[A-Z0-9]{4,10}" title="Solo letras may√∫sculas y n√∫meros (4-10 caracteres)">
                        <div class="form-hint">Solo may√∫sculas y n√∫meros</div>
                    </div>
                    <div class="form-group">
                        <label for="precioCodigo" class="form-label">
                            <i class="fas fa-dollar-sign"></i> PRECIO (S/):
                        </label>
                        <input type="number" id="precioCodigo" class="form-input" 
                               placeholder="6.00" min="0" step="0.01" value="6.00">
                        <div class="form-hint">Precio en soles</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button onclick="crearCodigoManual()" class="btn btn-success">
                            <i class="fas fa-check"></i> CREAR C√ìDIGO
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="üîç Buscar c√≥digo, usuario o contacto...">
                <select id="statusFilter" class="filter-select">
                    <option value="all">Todos los estados</option>
                    <option value="activo">Disponibles</option>
                    <option value="usado">Usados</option>
                    <option value="bloqueado">Bloqueados</option>
                </select>
                <button onclick="filtrarCodigos()" class="btn">
                    <i class="fas fa-filter"></i> FILTRAR
                </button>
                <button onclick="limpiarFiltros()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> LIMPIAR
                </button>
            </div>
        </div>

        <div id="mensajes"></div>
        
        <div id="lista">
            <div class="loading">
                <div class="loading-spinner"></div>
                Cargando datos del sistema...
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button class="pagination-btn disabled" id="prevPage">
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="pageInfo" style="padding: 10px 15px;">P√°gina 1 de 1</span>
            <button class="pagination-btn disabled" id="nextPage">
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN MEJORADA CON URLs QUE S√ç FUNCIONAN =====
        const SCRIPT_URLS = [
            'https://script.google.com/macros/s/AKfycbx7BL0jYif7kCc6U2xtGtSptEYtWaKLYeLgN9-8soNn2_Q59pyvlKiFQRxV3dfc2NpE/exec',
            'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://script.google.com/macros/s/AKfycbx7BL0jYif7kCc6U2xtGtSptEYtWaKLYeLgN9-8soNn2_Q59pyvlKiFQRxV3dfc2NpE/exec'),
            'https://corsproxy.org/?' + encodeURIComponent('https://script.google.com/macros/s/AKfycbx7BL0jYif7kCc6U2xtGtSptEYtWaKLYeLgN9-8soNn2_Q59pyvlKiFQRxV3dfc2NpE/exec')
        ];

        const BACKUP_STORAGE_KEY = 'neoStudyCodigosBackup';
        const CONFIG_STORAGE_KEY = 'neoStudyConfig';
        
        let currentScriptIndex = 0;

        function getScriptURL() {
            return SCRIPT_URLS[currentScriptIndex];
        }

        function switchScriptURL() {
            currentScriptIndex = (currentScriptIndex + 1) % SCRIPT_URLS.length;
            console.log(`üîÄ Cambiando a URL: ${currentScriptIndex + 1}`);
        }
        
        // ===== ESTADO GLOBAL =====
        let estadoGlobal = {
            codigos: {},
            filtros: {
                busqueda: '',
                estado: 'all'
            },
            paginacion: {
                paginaActual: 1,
                porPagina: 10,
                totalPaginas: 1
            },
            ultimaSincronizacion: null,
            online: false,
            sincronizando: false
        };

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Panel de Control Premium...');
            cargarConfiguracion();
            iniciarSincronizacionSilenciosa();
            configurarEventos();
        });

        function configurarEventos() {
            // B√∫squeda en tiempo real
            document.getElementById('searchInput').addEventListener('input', function(e) {
                estadoGlobal.filtros.busqueda = e.target.value;
                debounce(filtrarCodigos, 300)();
            });

            // Filtro por estado
            document.getElementById('statusFilter').addEventListener('change', function(e) {
                estadoGlobal.filtros.estado = e.target.value;
                filtrarCodigos();
            });

            // Teclas r√°pidas
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r': e.preventDefault(); cargarDatos(); break;
                        case 'n': e.preventDefault(); document.getElementById('nuevoCodigo').focus(); break;
                        case 'f': e.preventDefault(); document.getElementById('searchInput').focus(); break;
                    }
                }
            });
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatoFecha(fecha) {
            if (!fecha) return 'Nunca';
            return new Date(fecha).toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function tiempoRelativo(fecha) {
            if (!fecha) return 'nunca';
            
            const ahora = new Date();
            const diferencia = ahora - new Date(fecha);
            const minutos = Math.floor(diferencia / (1000 * 60));
            const horas = Math.floor(diferencia / (1000 * 60 * 60));
            
            if (minutos < 1) return 'ahora mismo';
            if (minutos < 60) return `hace ${minutos} min`;
            if (horas < 24) return `hace ${horas} h`;
            
            return formatoFecha(fecha);
        }

        // ===== GESTI√ìN DE CONFIGURACI√ìN =====
        function cargarConfiguracion() {
            const config = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            if (config.filtros) estadoGlobal.filtros = config.filtros;
            if (config.paginacion) estadoGlobal.paginacion = config.paginacion;
            if (config.ultimaSincronizacion) estadoGlobal.ultimaSincronizacion = config.ultimaSincronizacion;
            
            // Aplicar filtros guardados
            document.getElementById('searchInput').value = estadoGlobal.filtros.busqueda;
            document.getElementById('statusFilter').value = estadoGlobal.filtros.estado;
            
            // Actualizar UI de sincronizaci√≥n
            actualizarEstadoSincronizacion();
        }

        function guardarConfiguracion() {
            const config = {
                filtros: estadoGlobal.filtros,
                paginacion: estadoGlobal.paginacion,
                ultimaSincronizacion: estadoGlobal.ultimaSincronizacion
            };
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
        }

        // ===== SISTEMA DE SINCRONIZACI√ìN SILENCIOSA =====
        async function sincronizarSilenciosamente() {
            if (estadoGlobal.sincronizando) return;
            
            estadoGlobal.sincronizando = true;
            
            try {
                const response = await fetch(`${getScriptURL()}?action=getAllCodes&timestamp=${Date.now()}`);
                
                if (response.ok) {
                    const text = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.log('‚ö† Error parseando JSON en sincronizaci√≥n silenciosa');
                        return;
                    }
                    
                    if (data.status === 'success') {
                        const codigosAnteriores = JSON.stringify(estadoGlobal.codigos);
                        const codigosNuevos = JSON.stringify(data.codigos);
                        
                        if (codigosAnteriores !== codigosNuevos) {
                            estadoGlobal.codigos = data.codigos;
                            estadoGlobal.ultimaSincronizacion = new Date().toISOString();
                            localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(data.codigos));
                            actualizarInterfaz();
                            console.log('‚úÖ Sincronizaci√≥n silenciosa completada');
                        }
                        
                        estadoGlobal.online = true;
                    }
                }
            } catch (error) {
                console.log('‚ö† Error en sincronizaci√≥n silenciosa:', error.message);
                estadoGlobal.online = false;
                
                if (Object.keys(estadoGlobal.codigos).length === 0) {
                    usarSistemaLocal();
                }
            } finally {
                estadoGlobal.sincronizando = false;
                actualizarEstadoSincronizacion();
                guardarConfiguracion();
            }
        }

        function iniciarSincronizacionSilenciosa() {
            // Cargar datos iniciales
            cargarDatosIniciales();
            
            // Sincronizar cada 5 minutos silenciosamente
            setInterval(sincronizarSilenciosamente, 300000);
            
            // Sincronizar cuando la p√°gina se vuelve visible
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    sincronizarSilenciosamente();
                }
            });
        }

        async function cargarDatosIniciales() {
            try {
                // Primero intentar con Google Sheets
                const response = await fetch(`${getScriptURL()}?action=getAllCodes&timestamp=${Date.now()}`);
                
                if (response.ok) {
                    const text = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.log('‚ö† Error parseando JSON en carga inicial');
                        throw new Error('Formato de respuesta inv√°lido');
                    }
                    
                    if (data.status === 'success') {
                        estadoGlobal.codigos = data.codigos;
                        estadoGlobal.ultimaSincronizacion = new Date().toISOString();
                        estadoGlobal.online = true;
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(data.codigos));
                        actualizarInterfaz();
                        return;
                    }
                }
            } catch (error) {
                console.log('‚ö† Error cargando datos iniciales:', error);
            }
            
            // Fallback a datos locales
            usarSistemaLocal();
        }

        // ===== SISTEMA PRINCIPAL =====
        async function probarConexion() {
            actualizarEstadoSincronizacion('Probando conexi√≥n...', 'offline');
            
            try {
                const inicio = Date.now();
                // ‚ö†Ô∏è SIN HEADERS - Google Apps Script no los necesita
                const response = await fetch(`${getScriptURL()}?action=getAllCodes&timestamp=${Date.now()}`);
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error(`Error 429: Demasiadas solicitudes. Espera unos minutos.`);
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const text = await response.text();
                let data;
                
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('Error parseando JSON:', parseError, 'Respuesta:', text);
                    throw new Error('Respuesta inv√°lida del servidor');
                }
                
                const latencia = Date.now() - inicio;
                
                if (data.status === 'success') {
                    estadoGlobal.online = true;
                    actualizarEstadoSincronizacion(`Conectado (${latencia}ms)`, 'online');
                    mostrarMensaje(`‚úÖ ¬°CONEXI√ìN EXITOSA! Latencia: ${latencia}ms`, 'success');
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
            } catch (error) {
                estadoGlobal.online = false;
                actualizarEstadoSincronizacion('Sin conexi√≥n', 'error');
                
                if (error.message.includes('429')) {
                    mostrarMensaje(`‚ùå Error 429: Demasiadas solicitudes. Espera 1-2 minutos.`, 'error');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    switchScriptURL();
                } else if (error.message.includes('Failed to fetch')) {
                    mostrarMensaje(`‚ùå Error de CORS. Cambiando a servidor alternativo...`, 'error');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    switchScriptURL();
                    setTimeout(probarConexion, 3000);
                } else {
                    mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
                }
            }
        }

        async function forzarSincronizacion() {
            if (estadoGlobal.sincronizando) {
                mostrarMensaje('‚è≥ Sincronizaci√≥n en progreso...', 'warning');
                return;
            }
            
            estadoGlobal.sincronizando = true;
            mostrarMensaje('üîÑ Sincronizando con Google Sheets...', 'info-msg');
            
            try {
                const response = await fetch(`${getScriptURL()}?action=getAllCodes&timestamp=${Date.now()}`);
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('429: Demasiadas solicitudes. Intenta en 1-2 minutos.');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                let data;
                
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('Error JSON:', parseError);
                    throw new Error('Formato de respuesta inv√°lido');
                }
                
                if (data.status === 'success') {
                    estadoGlobal.codigos = data.codigos;
                    estadoGlobal.ultimaSincronizacion = new Date().toISOString();
                    estadoGlobal.online = true;
                    localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(data.codigos));
                    actualizarInterfaz();
                    mostrarMensaje('‚úÖ Sincronizaci√≥n completa', 'success');
                    guardarConfiguracion();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error sincronizaci√≥n:', error);
                
                if (error.message.includes('429') || error.message.includes('Failed to fetch')) {
                    mostrarMensaje(`‚ùå ${error.message}. Usando datos locales.`, 'error');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    switchScriptURL();
                } else {
                    mostrarMensaje(`‚ùå Error: ${error.message}. Usando datos locales.`, 'error');
                }
                
                usarSistemaLocal();
            } finally {
                estadoGlobal.sincronizando = false;
            }
        }

        async function cargarDatos() {
            try {
                mostrarMensaje('üîÑ Actualizando datos...', 'info-msg');
                
                const response = await fetch(`${getScriptURL()}?action=getAllCodes&timestamp=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const text = await response.text();
                let data;
                
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Formato de respuesta inv√°lido');
                }
                
                if (data.status === 'success') {
                    estadoGlobal.codigos = data.codigos;
                    estadoGlobal.ultimaSincronizacion = new Date().toISOString();
                    estadoGlobal.online = true;
                    localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(data.codigos));
                    actualizarInterfaz();
                    mostrarMensaje('‚úÖ Datos actualizados correctamente', 'success');
                    guardarConfiguracion();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.log('‚ö† Error con Google Sheets, usando datos locales:', error);
                estadoGlobal.online = false;
                usarSistemaLocal();
            }
        }

        function usarSistemaLocal() {
            const codigosBackup = JSON.parse(localStorage.getItem(BACKUP_STORAGE_KEY) || '{}');
            
            if (Object.keys(codigosBackup).length === 0) {
                const codigosIniciales = {
                    "MATH7X9": { 
                        estado: 'activo', usuario: null, precio: "6.00",
                        fechaCreacion: new Date().toLocaleString(), 
                        fechaActivacion: null,
                        contacto: null,
                        curso: "Planteo de Ecuaciones"
                    }
                };
                
                localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(codigosIniciales));
                estadoGlobal.codigos = codigosIniciales;
            } else {
                estadoGlobal.codigos = codigosBackup;
            }
            
            actualizarInterfaz();
            actualizarEstadoSincronizacion();
        }

        // ===== GESTI√ìN DE C√ìDIGOS =====
        async function crearCodigoManual() {
            const codigo = document.getElementById('nuevoCodigo').value.trim().toUpperCase();
            const precio = parseFloat(document.getElementById('precioCodigo').value).toFixed(2);
            
            // Validaciones
            if (!codigo) {
                mostrarMensaje('‚ùå Escribe un c√≥digo', 'error');
                return;
            }
            
            if (!/^[A-Z0-9]{4,10}$/.test(codigo)) {
                mostrarMensaje('‚ùå El c√≥digo debe tener 4-10 caracteres (solo may√∫sculas y n√∫meros)', 'error');
                return;
            }
            
            if (!precio || precio <= 0) {
                mostrarMensaje('‚ùå Precio inv√°lido', 'error');
                return;
            }

            // Verificar si ya existe
            if (estadoGlobal.codigos[codigo]) {
                mostrarMensaje('‚ùå Este c√≥digo ya existe', 'error');
                return;
            }

            try {
                const response = await fetch(getScriptURL(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createCode',
                        codigo: codigo,
                        precio: precio,
                        curso: 'Planteo de Ecuaciones'
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('429: Demasiadas solicitudes');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('nuevoCodigo').value = '';
                    mostrarMensaje(`‚úÖ C√≥digo creado: ${codigo}`, 'success');
                    // Sincronizar cambios
                    sincronizarSilenciosamente();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.log('‚ö† Error, creando localmente:', error);
                
                // Crear localmente
                estadoGlobal.codigos[codigo] = {
                    estado: 'activo', 
                    usuario: null, 
                    precio: precio,
                    fechaCreacion: new Date().toLocaleString(),
                    fechaActivacion: null,
                    contacto: null,
                    curso: 'Planteo de Ecuaciones'
                };
                
                localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                document.getElementById('nuevoCodigo').value = '';
                mostrarMensaje(`‚úÖ C√≥digo creado localmente: ${codigo}`, 'warning');
                actualizarInterfaz();
            }
        }

        async function generarCodigos() {
            const cantidad = 5;
            const precio = '6.00';
            
            try {
                const response = await fetch(getScriptURL(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'generateCodes',
                        cantidad: cantidad,
                        precio: precio,
                        curso: 'Planteo de Ecuaciones'
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('429: Demasiadas solicitudes');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    mostrarMensaje(`‚úÖ ${cantidad} c√≥digos generados!`, 'success');
                    // Sincronizar cambios
                    sincronizarSilenciosamente();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.log('‚ö† Error, generando localmente:', error);
                const nuevosCodigos = [];
                
                for (let i = 0; i < cantidad; i++) {
                    const codigo = generarCodigoUnico();
                    estadoGlobal.codigos[codigo] = {
                        estado: 'activo', 
                        usuario: null, 
                        precio: precio,
                        fechaCreacion: new Date().toLocaleString(),
                        fechaActivacion: null,
                        contacto: null,
                        curso: 'Planteo de Ecuaciones'
                    };
                    nuevosCodigos.push(codigo);
                }
                
                localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                mostrarMensaje(`‚úÖ ${cantidad} c√≥digos generados localmente`, 'warning');
                actualizarInterfaz();
            }
        }

        function generarCodigoUnico() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo;
            
            do {
                codigo = '';
                for (let i = 0; i < 7; i++) {
                    codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                }
            } while (estadoGlobal.codigos[codigo]);
            
            return codigo;
        }

        // ===== SISTEMA MEJORADO DE ASIGNACI√ìN POR ID DE PAGO =====
        async function asignarCodigoAUsuario() {
            // Pedir ID del pago para asignaci√≥n directa
            const paymentID = prompt("üÜî Ingresa el ID del pago (ej: pay_123456789_abcde):");
            if (!paymentID) return;

            // Buscar informaci√≥n del pago por ID
            const userInfo = await buscarUsuarioPorPaymentID(paymentID);
            
            if (!userInfo) {
                // Si no encuentra por ID, pedir datos manualmente
                return asignarCodigoManual();
            }

            // Mostrar confirmaci√≥n con datos del usuario
            const confirmacion = `
‚úÖ USUARIO ENCONTRADO POR ID:

üë§ Nombre: ${userInfo.nombre}
üìû Celular: ${userInfo.contacto}
üÜî ID Pago: ${paymentID}

¬øAsignar c√≥digo a este usuario?
            `.trim();

            if (!confirm(confirmacion)) {
                return;
            }

            const codigo = prompt("üîë Ingresa el c√≥digo a asignar (ej: MATH7X9):");
            if (!codigo) return;

            // Verificar c√≥digo
            if (!estadoGlobal.codigos[codigo]) {
                mostrarMensaje('‚ùå El c√≥digo no existe', 'error');
                return;
            }

            if (estadoGlobal.codigos[codigo].estado === 'usado') {
                mostrarMensaje('‚ùå Este c√≥digo ya est√° usado', 'error');
                return;
            }

            // ASIGNAR Y NOTIFICAR INMEDIATAMENTE
            await asignarYNotificarCodigo(codigo, userInfo, paymentID);
        }

        // ===== FUNCI√ìN MEJORADA PARA BUSCAR USUARIO =====
        async function buscarUsuarioPorPaymentID(paymentID) {
            try {
                // Buscar en el sistema principal
                const response = await fetch(`${getScriptURL()}?action=findUserByPaymentID&paymentID=${paymentID}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success' && result.user) {
                        return result.user;
                    }
                }
                
                // Buscar en localStorage como respaldo
                const pendingData = localStorage.getItem(`pending_${paymentID}`) || 
                                localStorage.getItem('lastPaymentAttempt');
                
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    return {
                        nombre: data.userName,
                        contacto: data.userContact
                    };
                }
                
                // Buscar en notificaciones pendientes
                const notificaciones = JSON.parse(localStorage.getItem('neoStudyNotificaciones') || '[]');
                const notificacion = notificaciones.find(notif => 
                    notif.paymentID === paymentID || notif.timestamp.includes(paymentID)
                );
                
                if (notificacion) {
                    return {
                        nombre: notificacion.usuario,
                        contacto: notificacion.contacto
                    };
                }
                
                return null;
                
            } catch (error) {
                console.log('Error buscando usuario por ID:', error);
                return null;
            }
        }

        // ===== ASIGNACI√ìN MANUAL (cuando no hay ID) =====
        async function asignarCodigoManual() {
            const codigo = prompt("üîë Ingresa el c√≥digo que quieres asignar (ej: MATH7X9):");
            if (!codigo) return;

            // Verificar que el c√≥digo existe
            if (!estadoGlobal.codigos[codigo]) {
                mostrarMensaje('‚ùå El c√≥digo no existe', 'error');
                return;
            }

            // Verificar disponibilidad
            if (estadoGlobal.codigos[codigo].estado === 'usado') {
                mostrarMensaje('‚ùå Este c√≥digo ya est√° usado', 'error');
                return;
            }

            const usuario = prompt("üë§ Ingresa el NOMBRE del usuario:");
            if (!usuario) return;

            const contacto = prompt("üìû Ingresa el N√öMERO de celular (solo n√∫meros):");
            if (!contacto) return;

            const userInfo = {
                nombre: usuario,
                contacto: contacto.replace(/\D/g, '') // Solo n√∫meros
            };

            await asignarYNotificarCodigo(codigo, userInfo, 'manual_' + Date.now());
        }

        // ===== FUNCI√ìN MEJORADA PARA ASIGNACI√ìN Y NOTIFICACI√ìN =====
        async function asignarYNotificarCodigo(codigo, userInfo, paymentID) {
            try {
                mostrarMensaje('üîÑ Asignando c√≥digo y notificando usuario...', 'info-msg');

                // 1. ASIGNAR C√ìDIGO EN EL SISTEMA
                const response = await fetch(getScriptURL(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'assignCodeToUser',
                        codigo: codigo,
                        usuario: userInfo.nombre,
                        contacto: userInfo.contacto,
                        paymentID: paymentID,
                        curso: 'Planteo de Ecuaciones'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    // 2. ACTUALIZAR LOCALMENTE INMEDIATAMENTE
                    estadoGlobal.codigos[codigo].estado = 'usado';
                    estadoGlobal.codigos[codigo].usuario = userInfo.nombre;
                    estadoGlobal.codigos[codigo].contacto = userInfo.contacto;
                    estadoGlobal.codigos[codigo].fechaActivacion = new Date().toLocaleString();
                    
                    localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                    
                    // 3. NUEVO: ACTIVAR NOTIFICACI√ìN PUSH PARA EL USUARIO
                    await activarNotificacionUsuario(codigo, userInfo);
                    
                    // 4. ENVIAR WHATSAPP INMEDIATO AL USUARIO
                    await enviarWhatsAppInmediato(codigo, userInfo);
                    
                    mostrarMensaje(`‚úÖ C√≥digo ${codigo} asignado a ${userInfo.nombre} y notificado`, 'success');
                    actualizarInterfaz();
                    
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Error, asignando localmente:', error);
                
                // ASIGNACI√ìN LOCAL DE EMERGENCIA
                estadoGlobal.codigos[codigo].estado = 'usado';
                estadoGlobal.codigos[codigo].usuario = userInfo.nombre;
                estadoGlobal.codigos[codigo].contacto = userInfo.contacto;
                estadoGlobal.codigos[codigo].fechaActivacion = new Date().toLocaleString();
                
                localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                
                // NUEVO: ACTIVAR NOTIFICACI√ìN LOCAL
                await activarNotificacionUsuario(codigo, userInfo);
                
                // ENVIAR WHATSAPP DE TODAS FORMAS
                await enviarWhatsAppInmediato(codigo, userInfo);
                
                mostrarMensaje(`‚úÖ C√≥digo ${codigo} asignado localmente a ${userInfo.nombre}`, 'warning');
                actualizarInterfaz();
            }
        }

        // ===== NUEVA FUNCI√ìN: NOTIFICACI√ìN PUSH PARA USUARIO =====
        async function activarNotificacionUsuario(codigo, userInfo) {
            try {
                // Crear notificaci√≥n en el sistema compartido
                const notificacion = {
                    codigo: codigo,
                    usuario: userInfo.nombre,
                    contacto: userInfo.contacto,
                    timestamp: new Date().toISOString(),
                    tipo: 'codigo_asignado',
                    curso: 'Planteo de Ecuaciones',
                    estado: 'pendiente'
                };
                
                // Guardar en localStorage compartido (para el m√≥dulo 4)
                const notificacionesExistentes = JSON.parse(localStorage.getItem('neoStudyNotificaciones') || '[]');
                notificacionesExistentes.push(notificacion);
                localStorage.setItem('neoStudyNotificaciones', JSON.stringify(notificacionesExistentes));
                
                // Guardar espec√≠ficamente para este usuario
                const userNotificationKey = `notificacion_${userInfo.contacto}`;
                localStorage.setItem(userNotificationKey, JSON.stringify(notificacion));
                
                console.log(`üì¢ Notificaci√≥n activada para: ${userInfo.contacto} - C√≥digo: ${codigo}`);
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error en notificaci√≥n push:', error);
            }
        }

        // ===== NUEVA FUNCI√ìN PARA VERIFICAR ASIGNACIONES PENDIENTES =====
        async function verificarAsignacionesPendientes() {
            try {
                // Buscar notificaciones pendientes en localStorage
                const notificaciones = JSON.parse(localStorage.getItem('neoStudyNotificaciones') || '[]');
                const pendientes = notificaciones.filter(notif => notif.estado === 'pendiente');
                
                if (pendientes.length > 0) {
                    mostrarMensaje(`üì¢ ${pendientes.length} notificaciones pendientes de env√≠o`, 'info-msg');
                    
                    // Reenviar notificaciones pendientes
                    for (const notif of pendientes) {
                        await reenviarNotificacion(notif);
                    }
                } else {
                    mostrarMensaje('‚úÖ No hay notificaciones pendientes', 'success');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Error verificando asignaciones pendientes:', error);
                mostrarMensaje('‚ùå Error verificando notificaciones pendientes', 'error');
            }
        }

        async function reenviarNotificacion(notificacion) {
            try {
                const userInfo = {
                    nombre: notificacion.usuario,
                    contacto: notificacion.contacto
                };
                
                await enviarWhatsAppInmediato(notificacion.codigo, userInfo);
                
                // Marcar como enviada
                notificacion.estado = 'enviada';
                notificacion.fechaEnvio = new Date().toISOString();
                
                // Actualizar localStorage
                const notificaciones = JSON.parse(localStorage.getItem('neoStudyNotificaciones') || '[]');
                const index = notificaciones.findIndex(n => 
                    n.codigo === notificacion.codigo && n.contacto === notificacion.contacto
                );
                
                if (index !== -1) {
                    notificaciones[index] = notificacion;
                    localStorage.setItem('neoStudyNotificaciones', JSON.stringify(notificaciones));
                }
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error reenviando notificaci√≥n:', error);
            }
        }

        // ===== NUEVA FUNCI√ìN EN EL PANEL PARA VERIFICACI√ìN R√ÅPIDA =====
        async function verificarAsignacionUsuario(contacto) {
            try {
                const codigosUsados = Object.entries(estadoGlobal.codigos).filter(([_, info]) => 
                    info.estado === 'usado' && info.contacto === contacto
                );
                
                if (codigosUsados.length > 0) {
                    return {
                        status: 'approved',
                        codigo: codigosUsados[0][0],
                        usuario: codigosUsados[0][1].usuario
                    };
                }
                
                return { status: 'not_found' };
            } catch (error) {
                return { status: 'error', message: error.message };
            }
        }

        // ===== ENV√çO DE WHATSAPP INMEDIATO =====
        async function enviarWhatsAppInmediato(codigo, userInfo) {
            const mensajeWhatsApp = `
üéâ ¬°PAGO VERIFICADO EXITOSAMENTE!

‚úÖ Tu comprobante ha sido aprobado
üîë Tu c√≥digo de acceso es: ${codigo}
üë§ Usuario: ${userInfo.nombre}
üìö Curso: Planteo de Ecuaciones

‚ö° **ACCESO INMEDIATO ACTIVADO**

¬°Ya puedes ingresar a todo el material del curso!
            `.trim();

            const urlWhatsApp = `https://wa.me/${userInfo.contacto}?text=${encodeURIComponent(mensajeWhatsApp)}`;
            
            // Abrir WhatsApp autom√°ticamente
            window.open(urlWhatsApp, '_blank');
            
            mostrarMensaje('üì± WhatsApp abierto para notificaci√≥n', 'success');
        }

        // ===== OPERACIONES SOBRE C√ìDIGOS =====
        async function copiarCodigo(codigo) {
            try {
                await navigator.clipboard.writeText(codigo);
                mostrarMensaje(`üìã C√≥digo ${codigo} copiado`, 'success');
            } catch (error) {
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = codigo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarMensaje(`üìã C√≥digo ${codigo} copiado`, 'success');
            }
        }

        async function bloquearCodigo(codigo) {
            if (confirm(`üö´ ¬øBLOQUEAR el c√≥digo ${codigo}?`)) {
                try {
                    const response = await fetch(getScriptURL(), {
                        method: 'POST',
                        body: JSON.stringify({action: 'blockCode', codigo: codigo})
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        mostrarMensaje('‚úÖ C√≥digo bloqueado', 'success');
                        sincronizarSilenciosamente();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    if (estadoGlobal.codigos[codigo]) {
                        estadoGlobal.codigos[codigo].estado = 'bloqueado';
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                        mostrarMensaje('‚úÖ C√≥digo bloqueado localmente', 'warning');
                        actualizarInterfaz();
                    }
                }
            }
        }

        async function activarCodigo(codigo) {
            try {
                const response = await fetch(getScriptURL(), {
                    method: 'POST',
                    body: JSON.stringify({action: 'activateCode', codigo: codigo})
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    mostrarMensaje('‚úÖ C√≥digo activado', 'success');
                    sincronizarSilenciosamente();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                if (estadoGlobal.codigos[codigo]) {
                    estadoGlobal.codigos[codigo].estado = 'activo';
                    localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                    mostrarMensaje('‚úÖ C√≥digo activado localmente', 'warning');
                    actualizarInterfaz();
                }
            }
        }

        async function editarPrecio(codigo) {
            const precioActual = estadoGlobal.codigos[codigo]?.precio || '6.00';
            const nuevoPrecio = prompt(`üí∞ Nuevo precio para ${codigo}:`, precioActual);
            
            if (nuevoPrecio && !isNaN(nuevoPrecio) && parseFloat(nuevoPrecio) > 0) {
                try {
                    const response = await fetch(getScriptURL(), {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'updatePrice',
                            codigo: codigo,
                            precio: parseFloat(nuevoPrecio).toFixed(2)
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        mostrarMensaje(`‚úÖ Precio actualizado: S/ ${nuevoPrecio}`, 'success');
                        sincronizarSilenciosamente();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    if (estadoGlobal.codigos[codigo]) {
                        estadoGlobal.codigos[codigo].precio = parseFloat(nuevoPrecio).toFixed(2);
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                        mostrarMensaje(`‚úÖ Precio actualizado localmente: S/ ${nuevoPrecio}`, 'warning');
                        actualizarInterfaz();
                    }
                }
            }
        }

        // ===== FUNCI√ìN MEJORADA PARA REVOCAR ACCESO =====
        async function revocarAcceso(codigo) {
            const info = estadoGlobal.codigos[codigo];
            const estado = info?.estado || 'activo';
            
            if (estado !== 'usado') {
                mostrarMensaje('‚ùå Solo puedes revocar acceso de c√≥digos USADOS', 'error');
                return;
            }

            const mensajeConfirmacion = `üö´ ¬øREVOCAR ACCESO del c√≥digo USADO ${codigo}?\n\nüìß USUARIO: ${info.usuario || 'Sin usuario'}\nüìû CONTACTO: ${info.contacto || 'Sin contacto'}\nüí∞ PRECIO: S/ ${info.precio || '6.00'}\n\n‚ö†Ô∏è El usuario perder√° acceso inmediatamente al material y vista previa`;

            if (confirm(mensajeConfirmacion)) {
                try {
                    mostrarMensaje('üîÑ Revocando acceso del usuario...', 'info-msg');
                    
                    // 1. BLOQUEAR EL C√ìDIGO (revocar acceso)
                    const response = await fetch(getScriptURL(), {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'blockCode', 
                            codigo: codigo,
                            razon: 'Acceso revocado por administrador'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        mostrarMensaje('‚úÖ‚úÖ Acceso revocado exitosamente. El usuario ya no podr√° acceder al material.', 'success');
                        
                        // Actualizar interfaz inmediatamente
                        sincronizarSilenciosamente();
                    } else {
                        throw new Error(result.message || 'Error al revocar acceso');
                    }
                    
                } catch (error) {
                    console.log('‚ö†Ô∏è Error, revocando localmente:', error);
                    
                    // Revocar acceso localmente si hay error
                    if (estadoGlobal.codigos[codigo]) {
                        estadoGlobal.codigos[codigo].estado = 'bloqueado';
                        estadoGlobal.codigos[codigo].accesoRevocado = true;
                        estadoGlobal.codigos[codigo].fechaRevocacion = new Date().toLocaleString();
                        estadoGlobal.codigos[codigo].razonRevocacion = 'Acceso revocado por administrador';
                        
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                        mostrarMensaje('‚ö†Ô∏è Acceso revocado localmente (modo offline)', 'warning');
                        actualizarInterfaz();
                    }
                }
            }
        }

        // ===== FUNCI√ìN PARA ELIMINAR C√ìDIGOS NO USADOS =====
        async function eliminarCodigo(codigo) {
            const info = estadoGlobal.codigos[codigo];
            const estado = info?.estado || 'activo';
            
            if (estado === 'usado') {
                // Para c√≥digos USADOS: usar revocarAcceso en lugar de eliminar
                revocarAcceso(codigo);
                return;
            }
            
            // Para c√≥digos NO USADOS: eliminar normalmente
            const mensajeConfirmacion = `üóë ¬øELIMINAR PERMANENTEMENTE el c√≥digo ${codigo}?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer`;
            
            if (confirm(mensajeConfirmacion)) {
                try {
                    const response = await fetch(getScriptURL(), {
                        method: 'POST',
                        body: JSON.stringify({action: 'deleteCode', codigo: codigo})
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        mostrarMensaje('‚úÖ C√≥digo eliminado del sistema', 'success');
                        sincronizarSilenciosamente();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error, eliminando localmente:', error);
                    
                    if (estadoGlobal.codigos[codigo]) {
                        delete estadoGlobal.codigos[codigo];
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(estadoGlobal.codigos));
                        mostrarMensaje('‚úÖ C√≥digo eliminado localmente', 'warning');
                        actualizarInterfaz();
                    }
                }
            }
        }

        // ===== FUNCI√ìN ADICIONAL PARA VER C√ìDIGOS ELIMINADOS =====
        function verCodigosEliminados() {
            estadoGlobal.filtros.estado = 'all';
            document.getElementById('statusFilter').value = 'all';
            
            // Filtrar solo c√≥digos marcados como eliminados
            let codigosEliminados = Object.entries(estadoGlobal.codigos).filter(([_, info]) => 
                info.eliminado === true
            );
            
            if (codigosEliminados.length === 0) {
                mostrarMensaje('‚ÑπÔ∏è No hay c√≥digos con acceso revocado', 'info-msg');
                aplicarFiltrosYMostrar();
            } else {
                mostrarListaCodigosPaginada(codigosEliminados);
                mostrarMensaje(`üîç Mostrando ${codigosEliminados.length} c√≥digos con acceso revocado`, 'info-msg');
            }
        }

        // ===== INTERFAZ Y VISUALIZACI√ìN =====
        function actualizarInterfaz() {
            mostrarEstadisticas(estadoGlobal.codigos);
            aplicarFiltrosYMostrar();
            actualizarEstadoSincronizacion();
            guardarConfiguracion();
        }

        function mostrarEstadisticas(codigos) {
            const total = Object.keys(codigos).length;
            const usados = Object.values(codigos).filter(c => c.estado === 'usado').length;
            const activos = Object.values(codigos).filter(c => c.estado === 'activo').length;
            const eliminados = Object.values(codigos).filter(c => c.eliminado === true).length;
            const ingresos = Object.values(codigos).filter(c => c.estado === 'usado').reduce((sum, c) => sum + parseFloat(c.precio || 0), 0);
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total C√≥digos</div>
                    <div class="stat-trend">${estadoGlobal.online ? 'üåê Online' : 'üì± Local'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${usados}</div>
                    <div class="stat-label">C√≥digos Usados</div>
                    <div class="stat-trend trend-up">${((usados/total)*100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${activos}</div>
                    <div class="stat-label">Disponibles</div>
                    <div class="stat-trend">${((activos/total)*100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${eliminados}</div>
                    <div class="stat-label">Accesos Revocados</div>
                    <div class="stat-trend trend-down">${eliminados > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">S/ ${ingresos.toFixed(2)}</div>
                    <div class="stat-label">Ingresos Totales</div>
                    <div class="stat-trend trend-up">${ingresos > 0 ? '‚ÜóÔ∏è' : '‚û°Ô∏è'}</div>
                </div>
            `;
        }

        function filtrarCodigos() {
            estadoGlobal.paginacion.paginaActual = 1;
            aplicarFiltrosYMostrar();
        }

        function limpiarFiltros() {
            estadoGlobal.filtros.busqueda = '';
            estadoGlobal.filtros.estado = 'all';
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            filtrarCodigos();
        }

        function aplicarFiltrosYMostrar() {
            let codigosFiltrados = Object.entries(estadoGlobal.codigos);
            
            // Aplicar filtro de b√∫squeda
            if (estadoGlobal.filtros.busqueda) {
                const busqueda = estadoGlobal.filtros.busqueda.toLowerCase();
                codigosFiltrados = codigosFiltrados.filter(([codigo, info]) => 
                    codigo.toLowerCase().includes(busqueda) ||
                    (info.usuario && info.usuario.toLowerCase().includes(busqueda)) ||
                    (info.contacto && info.contacto.toLowerCase().includes(busqueda))
                );
            }
            
            // Aplicar filtro de estado
            if (estadoGlobal.filtros.estado !== 'all') {
                codigosFiltrados = codigosFiltrados.filter(([_, info]) => 
                    info.estado === estadoGlobal.filtros.estado
                );
            }
            
            // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
            codigosFiltrados.sort((a, b) => {
                return new Date(b[1].fechaCreacion) - new Date(a[1].fechaCreacion);
            });
            
            mostrarListaCodigosPaginada(codigosFiltrados);
        }

        function mostrarListaCodigosPaginada(codigosFiltrados) {
            const totalItems = codigosFiltrados.length;
            const totalPaginas = Math.ceil(totalItems / estadoGlobal.paginacion.porPagina);
            estadoGlobal.paginacion.totalPaginas = totalPaginas;
            
            const inicio = (estadoGlobal.paginacion.paginaActual - 1) * estadoGlobal.paginacion.porPagina;
            const fin = inicio + estadoGlobal.paginacion.porPagina;
            const codigosPagina = codigosFiltrados.slice(inicio, fin);
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>üîë C√ìDIGOS ${estadoGlobal.filtros.estado !== 'all' ? `- ${estadoGlobal.filtros.estado.toUpperCase()}` : ''}</h2>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                        Mostrando ${codigosPagina.length} de ${totalItems} c√≥digos
                    </div>
                </div>
            `;
            
            if (codigosPagina.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h3>No se encontraron c√≥digos</h3>
                        <p>Intenta con otros t√©rminos de b√∫squeda o crea nuevos c√≥digos.</p>
                    </div>
                `;
            } else {
                codigosPagina.forEach(([codigo, info]) => {
                    const estado = info.estado || 'activo';
                    const estaEliminado = info.eliminado;
                    
                    // MEJORA VISUAL PARA C√ìDIGOS ELIMINADOS
                    const claseEstado = estaEliminado ? 'status-bloqueado' :
                                      estado === 'activo' ? 'status-activo' : 
                                      estado === 'usado' ? 'status-usado' : 'status-bloqueado';
                    
                    const textoEstado = estaEliminado ? 'ACCESO REVOCADO' :
                                      estado === 'activo' ? 'DISPONIBLE' : 
                                      estado === 'usado' ? 'USADO' : 'BLOQUEADO';
                    
                    const claseCodigo = estaEliminado ? 'bloqueado' : 
                                      estado === 'usado' ? 'usado' : 
                                      estado === 'activo' ? 'disponible' : 'bloqueado';
                    
                    html += `
                        <div class="codigo ${claseCodigo}">
                            <div class="codigo-header">
                                <div class="codigo-title">${codigo}</div>
                                <div class="codigo-meta">
                                    <span class="price-tag">S/ ${info.precio || '6.00'}</span>
                                    <span class="status-badge ${claseEstado}">${textoEstado}</span>
                                </div>
                            </div>
                            
                            ${info.usuario ? `
                                <div class="user-details">
                                    <div class="user-detail">
                                        <i class="fas fa-user"></i>
                                        <strong>${info.usuario}</strong>
                                    </div>
                                    <div class="user-detail">
                                        <i class="fas fa-phone"></i>
                                        ${info.contacto || 'Sin contacto'}
                                    </div>
                                    <div class="user-detail">
                                        <i class="fas fa-calendar"></i>
                                        ${info.fechaActivacion ? formatoFecha(info.fechaActivacion) : 'Sin fecha'}
                                    </div>
                                    ${estaEliminado ? `
                                        <div class="user-detail">
                                            <i class="fas fa-ban"></i>
                                            <strong style="color: var(--danger);">Acceso Revocado: ${info.fechaEliminacion || 'Fecha no disponible'}</strong>
                                        </div>
                                        <div class="user-detail">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span style="color: var(--warning);">${info.razonEliminacion || 'Sin raz√≥n especificada'}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="user-info">
                                    <i class="fas fa-gem"></i> <strong>DISPONIBLE PARA VENTA</strong>
                                </div>
                            `}
                            
                            <div class="timestamp">
                                <i class="fas fa-clock"></i> Creado: ${formatoFecha(info.fechaCreacion)}
                            </div>
                            
                            <div class="action-buttons">
                                <button class="action-btn" onclick="copiarCodigo('${codigo}')">
                                    <i class="fas fa-copy"></i> COPIAR
                                </button>
                                ${!info.usuario && !estaEliminado ? `
                                    <button class="action-btn ${estado === 'activo' ? 'btn-danger' : 'btn-success'}" 
                                            onclick="${estado === 'activo' ? 'bloquearCodigo' : 'activarCodigo'}('${codigo}')">
                                        <i class="fas ${estado === 'activo' ? 'fa-lock' : 'fa-unlock'}"></i>
                                        ${estado === 'activo' ? 'BLOQUEAR' : 'ACTIVAR'}
                                    </button>
                                ` : ''}
                                ${!estaEliminado ? `
                                    <button class="action-btn btn-warning" onclick="editarPrecio('${codigo}')">
                                        <i class="fas fa-edit"></i> EDITAR PRECIO
                                    </button>
                                ` : ''}
                                ${!estaEliminado && estado === 'usado' ? `
                                    <button class="action-btn btn-danger" onclick="revocarAcceso('${codigo}')">
                                        <i class="fas fa-ban"></i> REVOCAR ACCESO
                                    </button>
                                ` : ''}
                                ${!estaEliminado && estado !== 'usado' ? `
                                    <button class="action-btn btn-danger" onclick="eliminarCodigo('${codigo}')">
                                        <i class="fas fa-trash"></i> ELIMINAR
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('lista').innerHTML = html;
            configurarPaginacion(totalPaginas);
        }

        function configurarPaginacion(totalPaginas) {
            const paginationDiv = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPaginas <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            pageInfo.textContent = `P√°gina ${estadoGlobal.paginacion.paginaActual} de ${totalPaginas}`;
            
            // Configurar botones
            prevBtn.classList.toggle('disabled', estadoGlobal.paginacion.paginaActual === 1);
            nextBtn.classList.toggle('disabled', estadoGlobal.paginacion.paginaActual === totalPaginas);
            
            // Event listeners
            prevBtn.onclick = () => {
                if (estadoGlobal.paginacion.paginaActual > 1) {
                    estadoGlobal.paginacion.paginaActual--;
                    aplicarFiltrosYMostrar();
                }
            };
            
            nextBtn.onclick = () => {
                if (estadoGlobal.paginacion.paginaActual < totalPaginas) {
                    estadoGlobal.paginacion.paginaActual++;
                    aplicarFiltrosYMostrar();
                }
            };
        }

        async function verUsuarios() {
            estadoGlobal.filtros.estado = 'usado';
            document.getElementById('statusFilter').value = 'usado';
            filtrarCodigos();
            mostrarMensaje('üë• Mostrando usuarios con acceso activo', 'info-msg');
        }

        function verCodigos() {
            limpiarFiltros();
        }

        function mostrarMensaje(mensaje, tipo) {
            const mensajesDiv = document.getElementById('mensajes');
            mensajesDiv.innerHTML = `
                <div class="${tipo === 'success' ? 'success-msg' : 
                           tipo === 'warning' ? 'warning-msg' : 
                           tipo === 'info-msg' ? 'info-msg' : 'error'}">
                    ${mensaje}
                </div>
            `;
            
            // Auto-ocultar mensajes despu√©s de 5 segundos (excepto errores)
            if (tipo !== 'error') {
                setTimeout(() => {
                    if (mensajesDiv.innerHTML.includes(mensaje)) {
                        mensajesDiv.innerHTML = '';
                    }
                }, 5000);
            }
        }

        function actualizarEstadoSincronizacion() {
            const syncIndicator = document.getElementById('syncIndicator');
            const syncText = document.getElementById('syncText');
            const lastSync = document.getElementById('lastSync');
            
            if (estadoGlobal.online) {
                syncIndicator.className = 'sync-indicator online';
                syncText.textContent = 'Conectado';
                syncText.style.color = 'var(--success)';
            } else {
                syncIndicator.className = 'sync-indicator offline';
                syncText.textContent = 'Modo local';
                syncText.style.color = 'var(--warning)';
            }
            
            if (estadoGlobal.ultimaSincronizacion) {
                lastSync.textContent = `√öltima sync: ${tiempoRelativo(estadoGlobal.ultimaSincronizacion)}`;
            } else {
                lastSync.textContent = '√öltima sync: nunca';
            }
        }
    </script>
    
    <!-- Font Awesome para √≠conos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
